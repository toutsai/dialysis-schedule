<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>護理師組別統計報表 (V23.7 - 顏色邏輯更新版)</title>
    <style>
        /* CSS 與 V23.2 大部分相同 */
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; padding: 20px; background-color: #f9f9f9; }
        /* ... */
        /* --- CHANGE START: 顏色調整 --- */
        .patient-list-cell .tag-chou { background-color: #90caf9 !important; }
        .patient-list-cell .hospitalized { background-color: #ffcdd2 !important; }
        .patient-list-cell .tag-huan { background-color: #e3f2fd !important; } /* 新增 */
        .patient-list-cell .tag-liang { background-color: #ffcc80 !important; }
        .patient-list-cell .tag-b { background-color: #fffde7 !important; } /* 調整 */
        /* --- CHANGE END --- */
        @media print { /* ... */ }
    </style>
</head>
<body>
    <!-- HTML Body 結構無變更 -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // ... API 和其他設定無變動 ...

        // --- CHANGE START: 修正 formatPatientListWithColor 的顏色判斷邏輯 ---
        function formatPatientListWithColor(arr) {
            return arr.map(patientInfo => {
                const upperCaseInfo = patientInfo.toUpperCase();
                let className = '';

                if (upperCaseInfo.includes('抽')) {
                    className = 'tag-chou';
                } else if (upperCaseInfo.includes('住')) {
                    className = 'hospitalized';
                } else if (upperCaseInfo.includes('換')) {
                    className = 'tag-huan';
                } else if (upperCaseInfo.includes('兩')) {
                    className = 'tag-liang';
                } else if (upperCaseInfo.includes('B')) {
                    className = 'tag-b';
                }
                
                if (className) {
                    return `<span class="${className}">${patientInfo}</span>`;
                }
                return `<span>${patientInfo}</span>`;
            }).join('');
        }
        // --- CHANGE END ---
        
        // ... 其他 JS 函式與 V23.6 相同，為求完整複製貼上 ...
        const API_BASE_URL = 'https://684eb206f0c9c9848d28d637.mockapi.io/schedules';
        let currentDate = new Date();
        let currentRecord = null;
        const statusIndicator = document.getElementById('status-indicator');
        const dateDisplay = document.getElementById('current-date-display');
        const earlyTable = document.getElementById('early-shift-table');
        const lateTable = document.getElementById('late-shift-table');
        const saveNamesBtn = document.getElementById('save-names-btn');
        const clearNamesBtn = document.getElementById('clear-names-btn');
        const baseTeams = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', '外圍'];
        const nurseNameList = [ "陳素秋", "古孟麗", "謝常菁", "林玉麗", "陳聖柔", "田姿瑛", "陳韋吟", "劉姿秀", "劉舒婷", "李慈賢", "黃羿寧", "高佩鳳", "林沛儀", "李汶娟", "陳芃諭", "葛孟萍", "蘇愛玲", "郭芳君", "林馨如", "賴秋妏", "胡國暄", "施艾利", "陳淑玲", "謝慶諭", "林佩佳", "吳思婷", "曾佩君", "吳幸美" ];
        const nurseOptionsHTML = `<option value=""></option>` + nurseNameList.map(name => `<option value="${name}">${name}</option>`).join('');
        const formatDate = (date) => date.toISOString().split('T')[0];
        const setStatus = (message) => { statusIndicator.textContent = message; };
        const updateDisplayAndUrl = (dateObj) => { const dateStr = formatDate(dateObj); dateDisplay.textContent = `${dateStr} 統計報表`; const newUrl = new URL(window.location); newUrl.searchParams.set('date', dateStr); window.history.pushState({}, '', newUrl); };
        async function loadStatsFromCloud(dateStr) { earlyTable.innerHTML = ''; lateTable.innerHTML = ''; currentRecord = null; setStatus('讀取中...'); try { const response = await fetch(`${API_BASE_URL}?date=${dateStr}`); if (!response.ok) throw new Error('Network response was not ok'); const data = await response.json(); if (data.length > 0) { currentRecord = data[0]; loadReportData(currentRecord); setStatus('資料已載入'); } else { dateDisplay.textContent = `${dateStr} 無排程資料`; setStatus('本日無資料'); } } catch (error) { console.error('讀取報表資料失敗:', error); setStatus('讀取失敗'); } }
        async function saveNamesToCloud(namesObject) { if (!currentRecord) { alert("目前日期沒有排程資料，無法儲存。"); return; } currentRecord.names = namesObject; setStatus('儲存中...'); try { const response = await fetch(`${API_BASE_URL}/${currentRecord.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(currentRecord) }); if (!response.ok) throw new Error('Network response was not ok'); const action = Object.keys(namesObject).length > 0 ? '儲存' : '清空'; setStatus(`姓名資料已於 ${new Date().toLocaleTimeString()} ${action}成功`); alert(`護理師姓名資料已成功${action}！`); } catch (error) { console.error('儲存姓名失敗:', error); setStatus('儲存失敗'); alert('儲存姓名失敗，請稍後再試。'); } }
        function clearNames() { if (!currentRecord) { alert("目前沒有資料可清空。"); return; } if (!confirm("確定要清空本日所有的護理師姓名嗎？此操作將會儲存至雲端。")) { return; } document.querySelectorAll('.name-select').forEach(select => { select.value = ''; }); saveNamesToCloud({}); }
        function initialize() { const urlParams = new URLSearchParams(window.location.search); const dateFromUrl = urlParams.get('date'); if (dateFromUrl) { currentDate = new Date(dateFromUrl + 'T00:00:00'); } else { const today = new Date(); currentDate = new Date(today.getFullYear(), today.getMonth(), today.getDate()); } updateDisplayAndUrl(currentDate); loadStatsFromCloud(formatDate(currentDate)); }
        function loadReportData(fullData) { const { schedule, names } = fullData; const statsData = {}; const allNurseTeams = [...baseTeams.map(t => `早${t}`), ...baseTeams.map(t => `晚${t}`)]; allNurseTeams.forEach(team => { statsData[team] = { early: [], noon_in: [], noon_out: [], late: [] }; }); Object.keys(schedule).forEach(id => { const shiftData = schedule[id]; const patientName = shiftData.patient; if (!patientName) return; let bedNumberDisplay; if(id.startsWith('peripheral-')) { bedNumberDisplay = shiftData.bedNumber || '?'; } else { bedNumberDisplay = id.split('-')[1]; } const tag = shiftData.tag ? ` (${shiftData.tag})` : ''; const patientInfo = `${bedNumberDisplay} - ${patientName}${tag}`; if (id.includes('-早')) { if (shiftData.nurse && statsData[shiftData.nurse]) statsData[shiftData.nurse].early.push(patientInfo); } else if (id.includes('-晚')) { if (shiftData.nurse && statsData[shiftData.nurse]) statsData[shiftData.nurse].late.push(patientInfo); } else if (id.includes('-午')) { if (shiftData.nurse_in && statsData[shiftData.nurse_in]) { statsData[shiftData.nurse_in].noon_in.push(patientInfo); } if (shiftData.nurse_out && statsData[shiftData.nurse_out]) { statsData[shiftData.nurse_out].noon_out.push(patientInfo); } if (shiftData.nurse && statsData[shiftData.nurse]) { statsData[shiftData.nurse].noon_in.push(patientInfo); statsData[shiftData.nurse].noon_out.push(patientInfo); } } }); generateEarlyShiftTable(earlyTable, '早', statsData, names || {}); generateLateShiftTable(lateTable, '晚', statsData, names || {}); };
        function generateEarlyShiftTable(tableElement, shiftPrefix, statsData, statsNames) { tableElement.innerHTML = ''; const headerRow = document.createElement('tr'); headerRow.className = 'team-header-row'; headerRow.innerHTML = `<th class="row-header"></th>`; const nameRow = document.createElement('tr'); nameRow.innerHTML = `<th class="row-header">姓名</th>`; const earlyPatientsRow = document.createElement('tr'); earlyPatientsRow.innerHTML = `<th class="row-header">早班</th>`; const noonInPatientsRow = document.createElement('tr'); noonInPatientsRow.innerHTML = `<th class="row-header">午班(上針)</th>`; const noonOutPatientsRow = document.createElement('tr'); noonOutPatientsRow.innerHTML = `<th class="row-header">午班(收針)</th>`; baseTeams.forEach(team => { const fullTeamName = `${shiftPrefix}${team}`; const teamData = statsData[fullTeamName] || { early: [], noon_in: [], noon_out: [] }; headerRow.innerHTML += `<td>${fullTeamName}組</td>`; nameRow.innerHTML += `<td class="team-name-cell"><select class="name-select" data-team-id="${fullTeamName}">${nurseOptionsHTML}</select></td>`; earlyPatientsRow.innerHTML += `<td class="patient-list-cell">${formatPatientListWithColor(teamData.early)}</td>`; noonInPatientsRow.innerHTML += `<td class="patient-list-cell">${formatPatientListWithColor(teamData.noon_in)}</td>`; noonOutPatientsRow.innerHTML += `<td class="patient-list-cell">${formatPatientListWithColor(teamData.noon_out)}</td>`; }); tableElement.append(headerRow, nameRow, earlyPatientsRow, noonInPatientsRow, noonOutPatientsRow); tableElement.querySelectorAll('.name-select').forEach(s => { if (statsNames[s.dataset.teamId]) s.value = statsNames[s.dataset.teamId]; }); };
        function generateLateShiftTable(tableElement, shiftPrefix, statsData, statsNames) { tableElement.innerHTML = ''; const headerRow = document.createElement('tr'); headerRow.className = 'team-header-row'; headerRow.innerHTML = `<th class="row-header"></th>`; const nameRow = document.createElement('tr'); nameRow.innerHTML = `<th class="row-header">姓名</th>`; const noonOutPatientsRow = document.createElement('tr'); noonOutPatientsRow.innerHTML = `<th class="row-header">午班(收針)</th>`; const latePatientsRow = document.createElement('tr'); latePatientsRow.innerHTML = `<th class="row-header">晚班</th>`; baseTeams.forEach(team => { const fullTeamName = `${shiftPrefix}${team}`; const teamData = statsData[fullTeamName] || { noon_out: [], late: [] }; headerRow.innerHTML += `<td>${fullTeamName}組</td>`; nameRow.innerHTML += `<td class="team-name-cell"><select class="name-select" data-team-id="${fullTeamName}">${nurseOptionsHTML}</select></td>`; noonOutPatientsRow.innerHTML += `<td class="patient-list-cell">${formatPatientListWithColor(teamData.noon_out)}</td>`; latePatientsRow.innerHTML += `<td class="patient-list-cell">${formatPatientListWithColor(teamData.late)}</td>`; }); tableElement.append(headerRow, nameRow, noonOutPatientsRow, latePatientsRow); tableElement.querySelectorAll('.name-select').forEach(s => { if (statsNames[s.dataset.teamId]) s.value = statsNames[s.dataset.teamId]; }); };
        function changeDate(days) { currentDate.setDate(currentDate.getDate() + days); updateDisplayAndUrl(currentDate); loadStatsFromCloud(formatDate(currentDate)); }
        function goToToday() { currentDate = new Date(); const today = new Date(); currentDate.setHours(today.getHours(), today.getMinutes(), today.getSeconds(), today.getMilliseconds()); updateDisplayAndUrl(currentDate); const newUrl = new URL(window.location); newUrl.searchParams.delete('date'); window.history.pushState({}, '', newUrl); loadStatsFromCloud(formatDate(currentDate)); }
        saveNamesBtn.addEventListener('click', () => { const newNames = {}; document.querySelectorAll('.name-select').forEach(select => { if (select.value) { newNames[select.dataset.teamId] = select.value; } }); saveNamesToCloud(newNames); });
        clearNamesBtn.addEventListener('click', clearNames);
        document.getElementById('prev-date-btn').addEventListener('click', () => changeDate(-1));
        document.getElementById('next-date-btn').addEventListener('click', () => changeDate(1));
        document.getElementById('today-btn').addEventListener('click', goToToday);
        
        initialize();
    });
    </script>
</body>
</html>
