<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>護理師組別統計報表 (V24.0 - 統一數據源與拖曳功能版)</title>
    <style>
        /* CSS inalterado */
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; padding: 20px; background-color: #f9f9f9; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; max-width: 100%; margin: 0 auto 20px; }
        h1 { text-align: center; color: #333; flex-grow: 1; }
        .date-navigator { display: flex; align-items: center; gap: 10px; }
        #current-date-display { font-size: 1.5em; font-weight: bold; color: #333; }
        .date-nav-btn { font-size: 1.5em; padding: 0 10px; visibility: visible; }
        .controls { text-align: center; margin-bottom: 20px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .controls button { padding: 10px 20px; font-size: 1.1em; cursor: pointer; border-radius: 5px; border: 1px solid #ccc; }
        #save-names-btn { background-color: #4CAF50; color: white; border-color: #4CAF50;}
        #clear-names-btn { background-color: #f44336; color: white; border-color: #f44336; }
        .status-indicator { font-size: 0.9em; font-weight: bold; color: #757575; align-self: center; }
        .table-container { background-color: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stats-section { margin-bottom: 30px; }
        .stats-section h2 { font-size: 1.5em; color: #005a9c; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-bottom: 15px; }
        .stats-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .stats-table th, .stats-table td { border: 1px solid #ddd; padding: 6px; text-align: center; vertical-align: middle; font-size: 0.85em; word-wrap: break-word; }
        .stats-table th.row-header { background-color: #f2f2f2; font-weight: bold; width: 80px; }
        .team-header-row td { background-color: #e3f2fd; font-weight: bold; }
        .team-name-cell { padding: 0 !important; }
        .name-select { width: 100%; height: 100%; border: none; background-color: #fffde7; text-align: center; font-size: 1em; cursor: pointer; }
        .name-select:focus { outline: 2px solid #fbc02d; }
        .patient-list-cell { text-align: left; vertical-align: top; white-space: pre-wrap; min-height: 50px; }
        .patient-list-cell span { display: block; padding: 2px 4px; margin-bottom: 2px; border-radius: 3px; cursor: grab; }
        .patient-list-cell span:active { cursor: grabbing; }
        .patient-list-cell.drag-over { background-color: #e0f7fa !important; border: 2px dashed #0097a7; }
        .patient-list-cell .tag-chou { background-color: #90caf9 !important; }
        .patient-list-cell .hospitalized { background-color: #ffcdd2 !important; }
        .patient-list-cell .tag-huan { background-color: #e3f2fd !important; }
        .patient-list-cell .tag-liang { background-color: #ffcc80 !important; }
        .patient-list-cell .tag-b { background-color: #ffe0b2 !important; }

        /* --- CHANGE START: Add style for new save button for dragging --- */
        #save-groups-btn { background-color: #ff9800; color: white; border-color: #ff9800; display: none; }
        /* --- CHANGE END --- */
        
        @media print { body { padding: 10px; background-color: #fff; font-size: 8pt; } .controls, h1, .top-bar, .status-indicator { display: none; } .container { max-width: 100%; } .table-container { box-shadow: none; } .name-select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-color: transparent; } .patient-list-cell span { background-color: inherit !important; -webkit-print-color-adjust: exact; color-adjust: exact; cursor: default; } }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="date-navigator">
            <button id="prev-date-btn" class="date-nav-btn"><</button>
            <h1 id="current-date-display">統計報表</h1>
            <button id="next-date-btn" class="date-nav-btn">></button>
            <button id="today-btn">回到今日</button>
        </div>
    </div>
    <div class="container">
        <div class="controls">
            <button id="save-names-btn">儲存護理師姓名</button>
            <button id="clear-names-btn">清空護理師姓名</button>
            <!-- --- CHANGE START: Add new save button for dragging --- -->
            <button id="save-groups-btn">儲存組別變更</button>
            <!-- --- CHANGE END --- -->
            <button onclick="window.print()">列印報表</button>
            <div id="status-indicator" class="status-indicator"></div>
        </div>
        <div class="stats-section">
            <h2>早班組別</h2>
            <div class="table-container">
                <table class="stats-table" id="early-shift-table"></table>
            </div>
        </div>
        <div class="stats-section">
            <h2>晚班組別</h2>
            <div class="table-container">
                <table class="stats-table" id="late-shift-table"></table>
            </div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CHANGE START: Use the new unified endpoint ---
        const API_BASE_URL = 'https://6852ef850594059b23cfaa4f.mockapi.io/daily_records';
        // --- CHANGE END ---
        let currentDate = new Date();
        let currentRecord = null;
        
        const statusIndicator = document.getElementById('status-indicator');
        const dateDisplay = document.getElementById('current-date-display');
        const earlyTable = document.getElementById('early-shift-table');
        const lateTable = document.getElementById('late-shift-table');
        const saveNamesBtn = document.getElementById('save-names-btn');
        const clearNamesBtn = document.getElementById('clear-names-btn');
        // --- CHANGE START: Get new button and track group changes ---
        const saveGroupsBtn = document.getElementById('save-groups-btn');
        let hasGroupChanges = false;
        // --- CHANGE END ---

        const baseTeams = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', '外圍'];
        const nurseNameList = [ "陳素秋", "古孟麗", "謝常菁", "林玉麗", "陳聖柔", "田姿瑛", "陳韋吟", "劉姿秀", "劉舒婷", "李慈賢", "黃羿寧", "高佩鳳", "林沛儀", "李汶娟", "陳芃諭", "葛孟萍", "蘇愛玲", "郭芳君", "林馨如", "賴秋妏", "胡國暄", "施艾利", "陳淑玲", "謝慶諭", "林佩佳", "吳思婷", "曾佩君", "吳幸美" ];
        const nurseOptionsHTML = `<option value=""></option>` + nurseNameList.map(name => `<option value="${name}">${name}</option>`).join('');
        
        const formatDate = (date) => { /* ... no change ... */ };
        const setStatus = (message) => { /* ... no change ... */ };

        async function loadStatsFromCloud(dateStr) {
            earlyTable.innerHTML = '';
            lateTable.innerHTML = '';
            currentRecord = null;
            // --- CHANGE START: Reset change tracking state ---
            hasGroupChanges = false;
            saveGroupsBtn.style.display = 'none';
            // --- CHANGE END ---
            setStatus('讀取中...');
            
            try {
                // The API endpoint is now daily_records
                const response = await fetch(`${API_BASE_URL}?date=${dateStr}`);
                if (!response.ok) throw new Error('Network error');
                const data = await response.json();
                
                if (data.length > 0) {
                    currentRecord = data[0];
                    loadReportData(currentRecord);
                    setStatus('資料已載入');
                } else {
                    dateDisplay.textContent = `${dateStr} 無排程資料`;
                    setStatus('本日無資料');
                }
            } catch (error) {
                console.error('讀取報表資料失敗:', error);
                setStatus('讀取失敗');
            }
        }

        async function saveNamesToCloud(namesObject) {
            if (!currentRecord) { alert("目前日期沒有排程資料，無法儲存。"); return; }
            const dataToPatch = { names: namesObject };
            setStatus('儲存中...');
            try {
                const response = await fetch(`${API_BASE_URL}/${currentRecord.id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToPatch)
                });
                if (!response.ok) throw new Error('Save error');
                currentRecord.names = namesObject;
                const action = Object.keys(namesObject).length > 0 ? '儲存' : '清空';
                setStatus(`姓名資料已於 ${new Date().toLocaleTimeString()} ${action}成功`);
                alert(`護理師姓名資料已成功${action}！`);
            } catch (error) {
                console.error('儲存姓名失敗:', error);
                setStatus('儲存失敗');
            }
        }
        
        // --- CHANGE START: New function to save group changes ---
        async function saveGroupsToCloud() {
            if (!currentRecord || !hasGroupChanges) {
                alert('沒有組別變更需要儲存。');
                return;
            }

            const dataToPatch = {
                schedule: currentRecord.schedule
            };

            setStatus('儲存組別變更中...');
            try {
                const response = await fetch(`${API_BASE_URL}/${currentRecord.id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToPatch)
                });
                 if (!response.ok) throw new Error('Save error');

                hasGroupChanges = false;
                saveGroupsBtn.style.display = 'none';
                setStatus(`組別資料已於 ${new Date().toLocaleTimeString()} 儲存成功`);
                alert('組別變更已成功儲存！');
            } catch (error) {
                console.error('儲存組別變更失敗:', error);
                setStatus('儲存失敗');
            }
        }
        // --- CHANGE END ---

        function clearNames() { /* ... no change ... */ }

        // --- CHANGE START: Adapt data parsing to new structure and add drag listeners ---
        function loadReportData(fullData) {
            const { schedule, names } = fullData;
            const statsData = {};
            const allNurseTeams = [...baseTeams.map(t => `早${t}`), ...baseTeams.map(t => `晚${t}`), '午班(上針)', '午班(收針)']; //午班分開處理
            allNurseTeams.forEach(team => { statsData[team] = []; });

            // The main `schedule` object now holds all info
            Object.entries(schedule).forEach(([slotKey, slotData]) => {
                const { patientId, tag, nurse, nurse_in, nurse_out } = slotData;
                if (!patientId) return;

                const patient = { id: patientId, name: "未知病人" }; // Placeholder, assuming patient list not needed here
                const patientNameInSchedule = Object.values(fullData.schedule).find(s => s.patientId === patientId)?.patientNameInSchedule || patient.name; // This part is tricky without patient list. Let's just use the main name from the schedule itself for now. It might need a small adjustment if we need more info.
                
                // Let's parse the info from slotData for the patient display string
                // Example: We need to reconstruct the "bed - patientName (tag)" string
                // This requires a bit of assumption about slotKey format e.g. "1-0" or "peripheral-1-0"
                const keyParts = slotKey.split('-');
                let bedDisplay;
                if(slotKey.startsWith('peripheral')){
                    bedDisplay = slotData.bedNumber || `外圍${keyParts[1]}`;
                } else {
                    bedDisplay = keyParts[0];
                }
                const tagDisplay = tag ? ` (${tag})` : '';
                // For this to work, we'd ideally pass the full patient list or have name in slotData.
                // Assuming we can find the name. A simplified approach:
                const patientInfoString = `${bedDisplay} - [病人名]${tagDisplay}`; // We will add patient name later

                const patientInfo = {
                    slotKey: slotKey, // Store the key to identify the patient in the main schedule object
                    displayText: patientInfoString // Display text, name to be filled
                };

                if (nurse && statsData[nurse]) { statsData[nurse].push(patientInfo); }
                if (nurse_in && statsData['午班(上針)']) { statsData['午班(上針)'].push(patientInfo); }
                if (nurse_out && statsData['午班(收針)']) { statsData['午班(收針)'].push(patientInfo); }
            });
            
            // Refined data structure now. Let's try to populate the patient list more accurately.
            const patientListFromSchedule = {};
            for (const key in schedule) {
                 const pId = schedule[key].patientId;
                 patientListFromSchedule[pId] = patientListFromSchedule[pId] || { name: pId };
            }
             
            const finalStatsData = {};
            allNurseTeams.forEach(team => finalStatsData[team] = []);
            
            Object.keys(schedule).forEach(slotKey => {
                 const slot = schedule[slotKey];
                 if (!slot.patientId) return;
                 
                 let bedDisplay;
                 if (slotKey.startsWith('peripheral')) {
                     bedDisplay = slot.bedNumber || `外圍${slotKey.split('-')[1]}`;
                 } else {
                     bedDisplay = slotKey.split('-')[0];
                 }
                 const tagDisplay = slot.tag ? ` (${slot.tag})` : '';

                // This part is a placeholder. For real name, we'd need to fetch patients list.
                const patientName = `病人${slot.patientId.slice(-3)}`;
                const displayText = `${bedDisplay} - ${patientName}${tagDisplay}`;
                
                const patientInfo = { slotKey, displayText };

                // Now populate based on the nurse fields in the slot
                const [bed, shiftIndex] = slotKey.split('-');
                if(shiftIndex === '0') { // Early shift
                    if (slot.nurse && finalStatsData[slot.nurse]) finalStatsData[slot.nurse].push(patientInfo);
                } else if (shiftIndex === '2') { // Late shift
                    if (slot.nurse && finalStatsData[slot.nurse]) finalStatsData[slot.nurse].push(patientInfo);
                } else if (shiftIndex === '1') { // Noon shift
                    if(slot.nurse_in && finalStatsData[slot.nurse_in]) finalStatsData[slot.nurse_in].push({ ...patientInfo, type: 'noon_in'});
                    if(slot.nurse_out && finalStatsData[slot.nurse_out]) finalStatsData[slot.nurse_out].push({ ...patientInfo, type: 'noon_out'});
                }
            });

            generateEarlyShiftTable(earlyTable, '早', fullData.schedule, names || {});
            generateLateShiftTable(lateTable, '晚', fullData.schedule, names || {});
        }
        
        const formatPatientListWithColor = (arr) => {
             return arr.map(p => {
                const patientSpan = document.createElement('span');
                patientSpan.textContent = p.displayText;
                patientSpan.dataset.slotKey = p.slotKey; // Store the unique key
                patientSpan.draggable = true;

                const u = p.displayText.toUpperCase();
                if (u.includes('抽')) patientSpan.className = 'tag-chou';
                else if (u.includes('住')) patientSpan.className = 'hospitalized';
                else if (u.includes('換')) patientSpan.className = 'tag-huan';
                else if (u.includes('兩')) patientSpan.className = 'tag-liang';
                else if (u.includes('B')) patientSpan.className = 'tag-b';

                return patientSpan.outerHTML;
            }).join('');
        };
        
        function generateTable(tableElement, shiftPrefix, schedule, names) {
            const headerRow = `
                <tr class="team-header-row">
                    <th class="row-header"></th>
                    ${baseTeams.map(team => `<td>${shiftPrefix}${team}組</td>`).join('')}
                </tr>`;
            
            const nameRow = `
                <tr>
                    <th class="row-header">姓名</th>
                    ${baseTeams.map(team => `<td class="team-name-cell"><select class="name-select" data-team-id="${shiftPrefix}${team}">${nurseOptionsHTML}</select></td>`).join('')}
                </tr>`;

            const patientRows = {};
            if (shiftPrefix === '早') {
                patientRows['早班'] = { html: '<th class="row-header">早班</th>', shiftIndex: '0', nurseField: 'nurse' };
                patientRows['午班(上針)'] = { html: '<th class="row-header">午班(上針)</th>', shiftIndex: '1', nurseField: 'nurse_in' };
            }
            patientRows['午班(收針)'] = { html: '<th class="row-header">午班(收針)</th>', shiftIndex: '1', nurseField: 'nurse_out' };
            if (shiftPrefix === '晚') {
                patientRows['晚班'] = { html: '<th class="row-header">晚班</th>', shiftIndex: '2', nurseField: 'nurse' };
            }

            baseTeams.forEach(team => {
                const fullTeamName = `${shiftPrefix}${team}`;
                Object.values(patientRows).forEach(rowInfo => {
                    const patientsInGroup = Object.entries(schedule)
                        .filter(([key, slot]) => {
                            const [, sIndex] = key.split('-');
                            return sIndex === rowInfo.shiftIndex && slot[rowInfo.nurseField] === fullTeamName;
                        })
                        .map(([key, slot]) => {
                            let bedDisplay = slot.bedNumber || key.split('-')[0];
                             if (key.startsWith('peripheral')) bedDisplay = `外(${bedDisplay})`;
                            const tagDisplay = slot.tag ? ` (${slot.tag})` : '';
                            // This part is simplified, real name would need a patient list lookup
                            const patientName = `P-${slot.patientId.slice(-4)}`;
                            return { slotKey: key, displayText: `${bedDisplay} - ${patientName}${tagDisplay}` };
                        });
                    rowInfo.html += `<td class="patient-list-cell" data-team-id="${fullTeamName}" data-nurse-field="${rowInfo.nurseField}">${formatPatientListWithColor(patientsInGroup)}</td>`;
                });
            });

            tableElement.innerHTML = headerRow + nameRow + Object.values(patientRows).map(r => `<tr>${r.html}</tr>`).join('');
            tableElement.querySelectorAll('.name-select').forEach(s => { if (names[s.dataset.teamId]) s.value = names[s.dataset.teamId]; });
            addDragAndDropListeners(tableElement);
        }

        function generateEarlyShiftTable(table, prefix, schedule, names) { generateTable(table, prefix, schedule, names); }
        function generateLateShiftTable(table, prefix, schedule, names) { generateTable(table, prefix, schedule, names); }
        
        function addDragAndDropListeners(tableElement) {
            let draggedItem = null;

            tableElement.addEventListener('dragstart', (e) => {
                if (e.target.tagName === 'SPAN') {
                    draggedItem = e.target;
                    setTimeout(() => e.target.style.opacity = '0.5', 0);
                }
            });

            tableElement.addEventListener('dragend', (e) => {
                if (draggedItem) {
                    draggedItem.style.opacity = '1';
                    draggedItem = null;
                }
            });

            tableElement.addEventListener('dragover', (e) => {
                if (e.target.classList.contains('patient-list-cell')) {
                    e.preventDefault();
                    e.target.classList.add('drag-over');
                }
            });

            tableElement.addEventListener('dragleave', (e) => {
                if (e.target.classList.contains('patient-list-cell')) {
                    e.target.classList.remove('drag-over');
                }
            });

            tableElement.addEventListener('drop', (e) => {
                e.preventDefault();
                const dropZone = e.target.closest('.patient-list-cell');
                if (dropZone && draggedItem) {
                    dropZone.classList.remove('drag-over');
                    const slotKey = draggedItem.dataset.slotKey;
                    const newTeamId = dropZone.dataset.teamId;
                    const nurseField = dropZone.dataset.nurseField;
                    
                    if (currentRecord.schedule[slotKey]) {
                        // Update the nurse field in the local data model
                        currentRecord.schedule[slotKey][nurseField] = newTeamId;
                        
                        // Mark changes and show save button
                        hasGroupChanges = true;
                        saveGroupsBtn.style.display = 'inline-block';
                        setStatus('組別已變更，尚未儲存');

                        // Re-render the tables to reflect the change
                        loadReportData(currentRecord);
                    }
                }
            });
        }
        // --- CHANGE END ---
        
        function updateAndLoad(newDate) { /* ... no change ... */ }
        function changeDate(days) { /* ... no change ... */ }
        function goToToday() { /* ... no change ... */ }
        function initialize() { /* ... no change ... */ }

        saveNamesBtn.addEventListener('click', () => { /* ... no change ... */ });
        clearNamesBtn.addEventListener('click', clearNames);
        // --- CHANGE START: Add listener for new button ---
        saveGroupsBtn.addEventListener('click', saveGroupsToCloud);
        // --- CHANGE END ---
        document.getElementById('prev-date-btn').addEventListener('click', () => changeDate(-1));
        document.getElementById('next-date-btn').addEventListener('click', () => changeDate(1));
        document.getElementById('today-btn').addEventListener('click', goToToday);
        
        initialize();
    });
    </script>
</body>
</html>
