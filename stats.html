<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>護理師組別統計報表</title>
    <style>
        /* CSS 與前一版完全相同 */
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; padding: 20px; background-color: #f9f9f9; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; max-width: 100%; margin: 0 auto 20px; }
        h1 { text-align: center; color: #333; flex-grow: 1; }
        .date-navigator { display: flex; align-items: center; gap: 10px; }
        #current-date-display { font-size: 1.5em; font-weight: bold; color: #333; }
        .date-nav-btn { font-size: 1.5em; padding: 0 10px; visibility: hidden; }
        .controls { text-align: center; margin-bottom: 20px; display: flex; justify-content: center; gap: 15px; }
        .controls button { padding: 10px 20px; font-size: 1.1em; cursor: pointer; border-radius: 5px; border: 1px solid #ccc; }
        #save-names-btn { background-color: #4CAF50; color: white; border-color: #4CAF50;}
        .table-container { background-color: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stats-section { margin-bottom: 30px; }
        .stats-section h2 { font-size: 1.5em; color: #005a9c; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-bottom: 15px; }
        .stats-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .stats-table th, .stats-table td { border: 1px solid #ddd; padding: 6px; text-align: center; vertical-align: middle; font-size: 0.85em; word-wrap: break-word; }
        .stats-table th.row-header { background-color: #f2f2f2; font-weight: bold; width: 80px; }
        .team-header-row td { background-color: #e3f2fd; font-weight: bold; }
        .team-name-cell { padding: 0 !important; }
        .name-select { width: 100%; height: 100%; border: none; background-color: #fffde7; text-align: center; font-size: 1em; cursor: pointer; }
        .name-select:focus { outline: 2px solid #fbc02d; }
        .patient-list-cell { text-align: left; vertical-align: top; white-space: pre-wrap; min-height: 50px; }
        .patient-list-cell span { display: block; padding: 2px 4px; margin-bottom: 2px; border-radius: 3px; }
        .patient-list-cell .hospitalized { background-color: #ffcdd2 !important; }
        .patient-list-cell .tag-chou { background-color: #90caf9 !important; }
        .patient-list-cell .tag-liang { background-color: #ffcc80 !important; }
        @media print { body { padding: 10px; background-color: #fff; font-size: 8pt; } .controls, h1, .top-bar { display: none; } .container { max-width: 100%; } .table-container { box-shadow: none; } .name-select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-color: transparent; } .patient-list-cell span { background-color: inherit !important; -webkit-print-color-adjust: exact; color-adjust: exact; } }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="date-navigator">
            <h1 id="current-date-display">統計報表</h1>
        </div>
    </div>
    <div class="container">
        <div class="controls">
            <button id="save-names-btn">將姓名變更同步回排程表</button>
            <button onclick="window.print()">列印報表</button>
        </div>
        <div class="stats-section">
            <h2>早班組別</h2>
            <div class="table-container">
                <table class="stats-table" id="early-shift-table"></table>
            </div>
        </div>
        <div class="stats-section">
            <h2>晚班組別</h2>
            <div class="table-container">
                <table class="stats-table" id="late-shift-table"></table>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dateDisplay = document.getElementById('current-date-display');
            const earlyTable = document.getElementById('early-shift-table');
            const lateTable = document.getElementById('late-shift-table');
            const saveNamesBtn = document.getElementById('save-names-btn');
            const baseTeams = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', '外圍'];
            const nurseNameList = [ "陳素秋", "古孟麗", "謝常菁", "林玉麗", "陳聖柔", "田姿瑛", "陳韋吟", "劉姿秀", "劉舒婷", "李慈賢", "黃羿寧", "高佩鳳", "林沛儀", "李汶娟", "陳芃諭", "葛孟萍", "蘇愛玲", "郭芳君", "林馨如", "賴秋妏", "胡國暄", "施艾利", "陳淑玲", "謝慶諭", "林佩佳", "吳思婷", "曾佩君", "吳幸美" ];
            const nurseOptionsHTML = `<option value=""></option>` + nurseNameList.map(name => `<option value="${name}">${name}</option>`).join('');

            // --- CHANGE START: 全新的資料處理邏輯 ---
            function initialize() {
                // 從打開此頁面的 schedule.html 獲取資料
                if (window.opener && window.opener.currentScheduleDataForStats) {
                    const data = window.opener.currentScheduleDataForStats;
                    loadReportData(data);
                } else {
                    dateDisplay.textContent = "錯誤：請從排程表頁面開啟此報表";
                    alert("請不要直接打開此檔案。請先開啟 schedule.html，然後點擊「查看統計報表」。");
                }
            }
            
            function loadReportData(fullData) {
                const { date, schedule, names } = fullData;
                dateDisplay.textContent = `${date} 統計報表`;
                earlyTable.innerHTML = ''; 
                lateTable.innerHTML = '';
                const statsData = {};
                const allTeams = [...baseTeams.map(t => `早${t}`), ...baseTeams.map(t => `晚${t}`)];
                allTeams.forEach(team => { 
                    statsData[team] = { early: [], noon_in: [], noon_out: [], late: [] }; 
                });
                Object.keys(schedule).forEach(id => { 
                    const shiftData = schedule[id]; 
                    const patientName = shiftData.patient; 
                    if (!patientName) return; 
                    let bedNumber; 
                    if(id.startsWith('peripheral-')) { 
                        bedNumber = `外圍(${shiftData.bedNumber || '?'})`; 
                    } else { 
                        bedNumber = id.split('-')[1]; 
                    } 
                    const tag = shiftData.tag ? ` (${shiftData.tag})` : ''; 
                    const patientInfo = `${bedNumber} - ${patientName}${tag}`; 
                    if (id.includes('-早')) {
                        if (shiftData.nurse && statsData[shiftData.nurse]) statsData[shiftData.nurse].early.push(patientInfo);
                    } else if (id.includes('-晚')) {
                        if (shiftData.nurse && statsData[shiftData.nurse]) statsData[shiftData.nurse].late.push(patientInfo);
                    } else if (id.includes('-午')) {
                        if (shiftData.nurse_in && statsData[shiftData.nurse_in]) statsData[shiftData.nurse_in].noon_in.push(patientInfo);
                        if (shiftData.nurse_out && statsData[shiftData.nurse_out]) statsData[shiftData.nurse_out].noon_out.push(patientInfo);
                    }
                });
                generateEarlyShiftTable(earlyTable, '早', statsData, names || {});
                generateLateShiftTable(lateTable, '晚', statsData, names || {});
            }
            
            function formatPatientListWithColor(arr) { /* ...與前一版相同... */ }
            function generateEarlyShiftTable(tableElement, shiftPrefix, statsData, statsNames) { /* ...與前一版相同... */ }
            function generateLateShiftTable(tableElement, shiftPrefix, statsData, statsNames) { /* ...與前一版相同... */ }
            // 複製貼上這三個函式，因為它們內容不變
            formatPatientListWithColor = (arr) => arr.map(p => { let c = ''; if (p.includes('(住)')) c = 'hospitalized'; else if (p.includes('(抽)')) c = 'tag-chou'; else if (p.includes('(兩)')) c = 'tag-liang'; return c ? `<span class="${c}">${p}</span>` : `<span>${p}</span>`; }).join('');
            generateEarlyShiftTable = (tableElement, shiftPrefix, statsData, statsNames) => { const h = document.createElement('tr'); h.className = 'team-header-row'; h.innerHTML = `<th class="row-header"></th>`; const n = document.createElement('tr'); n.innerHTML = `<th class="row-header">姓名</th>`; const e = document.createElement('tr'); e.innerHTML = `<th class="row-header">早班</th>`; const i = document.createElement('tr'); i.innerHTML = `<th class="row-header">午班(上針)</th>`; const o = document.createElement('tr'); o.innerHTML = `<th class="row-header">午班(收針)</th>`; baseTeams.forEach(t => { const f = `${shiftPrefix}${t}`; const d = statsData[f] || { early: [], noon_in: [], noon_out: [] }; h.innerHTML += `<td>${f}組</td>`; n.innerHTML += `<td class="team-name-cell"><select class="name-select" data-team-id="${f}">${nurseOptionsHTML}</select></td>`; e.innerHTML += `<td class="patient-list-cell">${formatPatientListWithColor(d.early)}</td>`; i.innerHTML += `<td class="patient-list-cell">${formatPatientListWithColor(d.noon_in)}</td>`; o.innerHTML += `<td class="patient-list-cell">${formatPatientListWithColor(d.noon_out)}</td>`; }); tableElement.append(h, n, e, i, o); tableElement.querySelectorAll('.name-select').forEach(s => { if (statsNames[s.dataset.teamId]) s.value = statsNames[s.dataset.teamId]; }); };
            generateLateShiftTable = (tableElement, shiftPrefix, statsData, statsNames) => { const h = document.createElement('tr'); h.className = 'team-header-row'; h.innerHTML = `<th class="row-header"></th>`; const n = document.createElement('tr'); n.innerHTML = `<th class="row-header">姓名</th>`; const o = document.createElement('tr'); o.innerHTML = `<th class="row-header">午班(收針)</th>`; const l = document.createElement('tr'); l.innerHTML = `<th class="row-header">晚班</th>`; baseTeams.forEach(t => { const f = `${shiftPrefix}${t}`; const d = statsData[f] || { noon_out: [], late: [] }; h.innerHTML += `<td>${f}組</td>`; n.innerHTML += `<td class="team-name-cell"><select class="name-select" data-team-id="${f}">${nurseOptionsHTML}</select></td>`; o.innerHTML += `<td class="patient-list-cell">${formatPatientListWithColor(d.noon_out)}</td>`; l.innerHTML += `<td class="patient-list-cell">${formatPatientListWithColor(d.late)}</td>`; }); tableElement.append(h, n, o, l); tableElement.querySelectorAll('.name-select').forEach(s => { if (statsNames[s.dataset.teamId]) s.value = statsNames[s.dataset.teamId]; }); };

            function saveNamesAndSyncBack() {
                if (!window.opener || window.opener.closed) {
                    alert("錯誤：找不到來源的排程表頁面。請不要關閉排程表頁面。");
                    return;
                }
                const namesToSave = {};
                document.querySelectorAll('.name-select').forEach(select => {
                    namesToSave[select.dataset.teamId] = select.value;
                });
                
                // 呼叫 opener (schedule.html) 的全域函式，把新資料傳回去
                window.opener.updateNamesFromStats(namesToSave);
                window.close(); // 同步後自動關閉此視窗
            }
            
            saveNamesBtn.addEventListener('click', saveNamesAndSyncBack);
            
            initialize();
            // --- CHANGE END ---
        });
    </script>
</body>
</html>
