// 在 document.addEventListener('DOMContentLoaded', ... 的結尾處加入

// --- 新增：資料維護功能 ---
const maintenanceBtn = document.getElementById('maintenance-btn');
maintenanceBtn.addEventListener('click', async () => {
    const retentionDays = 90; // 設定要保留的天數，例如 90 天
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - retentionDays);
    
    const friendlyDate = `${cutoffDate.getFullYear()}/${cutoffDate.getMonth() + 1}/${cutoffDate.getDate()}`;

    if (!confirm(`這個操作將會永久刪除所有 ${retentionDays} 天前 (${friendlyDate} 之前) 的每日排程雲端記錄。\n\n這個動作無法復原，您確定要繼續嗎？`)) {
        return;
    }

    setStatus('開始進行資料維護...', 'loading');
    maintenanceBtn.disabled = true;

    try {
        // 1. 取得所有排程資料
        const response = await fetch(API.schedules);
        if (!response.ok) throw new Error('無法獲取所有排程資料');
        const allSchedules = await response.json();

        // 2. 找出需要刪除的舊資料
        const recordsToDelete = allSchedules.filter(record => {
            const recordDate = new Date(record.date);
            return recordDate < cutoffDate;
        });

        if (recordsToDelete.length === 0) {
            alert('沒有找到需要清除的舊資料。');
            setStatus('維護完成', 'saved');
            maintenanceBtn.disabled = false;
            return;
        }

        // 3. 逐一發送刪除請求
        let deletedCount = 0;
        for (const record of recordsToDelete) {
            try {
                await fetch(`${API.schedules}/${record.id}`, { method: 'DELETE' });
                deletedCount++;
                setStatus(`正在刪除舊資料... (${deletedCount}/${recordsToDelete.length})`, 'loading');
            } catch (delError) {
                console.error(`刪除 ID: ${record.id} 失敗`, delError);
                // 即使單筆失敗也繼續
            }
        }

        alert(`資料維護完成！共刪除了 ${deletedCount} 筆舊記錄。`);
        setStatus('維護完成', 'saved');

    } catch (error) {
        console.error('資料維護失敗:', error);
        setStatus('維護失敗', 'error');
        alert('資料維護過程中發生錯誤，請檢查主控台訊息。');
    } finally {
        maintenanceBtn.disabled = false;
    }
});
