<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>洗腎室床位病人排程表 (V33.2 - 穩定版)</title>
    <style>
        /* CSS is unchanged and correct */
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f4f7f6; padding: 20px; color: #333; }
        .controls-panel { max-width: 1800px; margin: 0 auto 20px; padding: 15px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
        #save-btn { background-color: #4CAF50; color: white; border-color: #4CAF50;}
        #print-btn { background-color: #008CBA; color: white; border-color: #008CBA;}
        #clear-all-btn { background-color: #f44336; color: white; border-color: #f44336;}
        #copy-schedule-btn { background-color: #ff9800; color: white; border-color: #ff9800;}
        .inpatient-sidebar { width: 240px; flex-shrink: 0; background-color: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6; max-height: 80vh; display: flex; flex-direction: column;}
        .inpatient-sidebar h3 { margin-top: 0; text-align: center; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; margin-bottom: 10px; }
        .filter-group { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
        .filter-group button { padding: 4px 8px; font-size: 0.8em; flex-grow: 1; border: 1px solid #ccc; background-color: #fff; cursor: pointer;}
        .filter-group button:hover { background-color: #f0f0f0; }
        .filter-group button.active { background-color: #007bff; color: white; border-color: #007bff; }
        #inpatient-list { list-style-type: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        #inpatient-list li { background-color: #fff; border: 1px solid #e0e0e0; padding: 8px 12px; margin-bottom: 8px; border-radius: 5px; display: flex; flex-direction: column; align-items: flex-start; gap: 4px; transition: background-color 0.3s; }
        #inpatient-list li.scheduled-inpatient { background-color: #fff59d; border-left: 5px solid #007bff; }
    </style>
</head>
<body>
    <!-- Full HTML structure remains the same -->
    <div class="date-navigator">
        <button id="prev-date-btn" class="date-nav-btn"><</button>
        <h1 id="current-date-display"></h1>
        <span id="weekday-display"></span>
        <button id="next-date-btn" class="date-nav-btn">></button>
        <button id="today-btn">回到今日</button>
    </div>
    <div class="controls-panel">
        <button id="save-btn">儲存並同步週排班</button>
        <button id="print-btn">列印排程</button>
        <button id="clear-all-btn">清空本日畫面</button>
        <input type="date" id="copy-source-date">
        <button id="copy-schedule-btn">從他日複製排程</button>
        <div class="search-group">
            <input type="text" id="search-input" placeholder="搜尋...">
            <button id="search-btn">搜尋</button>
        </div>
        <div class="shift-patient-count">
            <div>早班：<span id="early-shift-count">0</span></div>
            <div>午班：<span id="noon-shift-count">0</span></div>
            <div>晚班：<span id="late-shift-count">0</span></div>
        </div>
        <div id="status-indicator" class="status-indicator"></div>
    </div>
    <div class="main-container">
        <div class="schedule-content">
            <div class="dialysis-unit">
                <div class="left-wing" id="left-wing"></div>
                <div class="aisle">中 央 走 道</div>
                <div class="right-wing" id="right-wing"></div>
            </div>
            <div class="extra-sections">
                <div class="peripheral-section">
                    <h2>外圍床位</h2>
                    <div class="peripheral-bed-container" id="peripheral-bed-container"></div>
                </div>
            </div>
        </div>
        <aside class="inpatient-sidebar">
            <h3>住院病人清單</h3>
            <div class="filter-group" id="filter-group">
                <button data-filter="all" class="active">全部</button>
                <button data-filter="135">一三五</button>
                <button data-filter="246">二四六</button>
                <button data-filter="other">其他</button>
            </div>
            <ul id="inpatient-list"></ul>
        </aside>
    </div>

    <script src="api_manager.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- All code now lives inside this event listener ---

        const schedulesApi = ApiManager('schedules');
        const patientsApi = ApiManager('patients');
        const weeklyScheduleApi = ApiManager('weekly_schedule');

        let currentDate = new Date();
        let currentRecord = null;
        let allPatients = [];
        let inpatientFilter = 'all';

        const statusIndicator = document.getElementById('status-indicator');
        const baseTeams = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', '外圍'];
        const earlyTeams = baseTeams.map(t => `早${t}`);
        const lateTeams = baseTeams.map(t => `晚${t}`);
        const allTeams = [...earlyTeams, ...lateTeams]; 
        const earlyOptionsHTML = `<option value=""></option>` + earlyTeams.map(team => `<option value="${team}">${team}組</option>`).join('');
        const lateOptionsHTML = `<option value=""></option>` + lateTeams.map(team => `<option value="${team}">${team}組</option>`).join('');
        const allOptionsHTML = `<option value=""></option>` + allTeams.map(team => `<option value="${team}">${team}組</option>`).join('');
        const layoutData = { leftWingRows: [['空', 32, 31], [33, 35, 36], [39, 38, 37], [51, 52, 53], [57, 56, 55], [58, 59, 61], [65, 63, 62]], rightWingRows: [[29, 28, 27], [23, 25, 26], [22, 21, 19], [16, 17, 18], [15, 13, 12], [8, 9, 11], [7, 6, 5], [1, 2, 3]] };
        const aisleSideBeds = [1, 7, 8, 15, 16, 22, 23, 29, 31, 36, 37, 53, 55, 61, 62, 65];
        const hepatitisBeds = ['空', 31, 32, 33, 35, 36];
        const peripheralBedCount = 6;
        
        const getStartOfWeek = (date) => { const d = new Date(date); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1); return new Date(new Date(d.setDate(diff)).setHours(0, 0, 0, 0)); }
        const shiftToIndexMap = { '早': 0, '午': 1, '晚': 2 };
        const formatDate = (date) => { const year = date.getFullYear(); const month = (date.getMonth() + 1).toString().padStart(2, '0'); const day = date.getDate().toString().padStart(2, '0'); return `${year}-${month}-${day}`; };
        const setStatus = (message, type) => { statusIndicator.textContent = message; statusIndicator.className = `status-indicator ${type}`; };
        const printSchedule = () => window.print();

        function clearBoardUi() {
            document.querySelectorAll('.newly-synced').forEach(el => el.classList.remove('newly-synced'));
            document.querySelectorAll('.nurse-team-select').forEach(s => { s.value = ''; s.title=''; });
            document.querySelectorAll('div[contenteditable="true"]').forEach(d => d.textContent = '');
            document.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight'));
            document.querySelectorAll('.tag-chou, .tag-new, .hospitalized, .tag-huan, .tag-liang, .tag-b, .status-opd').forEach(el => el.classList.remove('tag-chou', 'tag-new', 'hospitalized', 'tag-huan', 'tag-liang', 'tag-b', 'status-opd'));
            updateShiftPatientCount();
        }

        const updateShiftPatientCount = () => {
            let earlyCount = 0, noonCount = 0, lateCount = 0;
            document.querySelectorAll('.patient-name, .peripheral-patient-name').forEach(patientField => {
                if (patientField.textContent.trim() !== '') {
                    const parentRow = patientField.closest('.shift-row, .peripheral-shift-row');
                    if (parentRow) {
                        const shiftId = parentRow.dataset.shiftId;
                        if (shiftId.includes('-早')) earlyCount++;
                        else if (shiftId.includes('-午')) noonCount++;
                        else if (shiftId.includes('-晚')) lateCount++;
                    }
                }
            });
            document.getElementById('early-shift-count').textContent = earlyCount;
            document.getElementById('noon-shift-count').textContent = noonCount;
            document.getElementById('late-shift-count').textContent = lateCount;
            renderInpatientList();
        };
        
        function updatePatientCellStyle(patientCell) {
            if (!patientCell || !patientCell.textContent) {
                if (patientCell) patientCell.className = patientCell.className.split(' ').filter(c => !c.startsWith('tag-') && c !== 'hospitalized' && c !== 'status-opd').join(' ');
                return;
            }
            const patientName = patientCell.textContent.trim();
            const patient = allPatients.find(p => p.name === patientName);
            if (!patient) return;
            const parentRow = patientCell.closest('.shift-row, .peripheral-shift-row');
            const tagElement = parentRow.querySelector('.patient-tag');
            const tagText = tagElement ? tagElement.textContent.toUpperCase() : '';
            patientCell.className = patientCell.className.split(' ').filter(c => !c.startsWith('tag-') && c !== 'hospitalized' && c !== 'status-opd').join(' ');
            let styleApplied = false;
            if (tagText.includes('抽')) { patientCell.classList.add('tag-chou'); styleApplied = true;
            } else if (tagText.includes('新')) { patientCell.classList.add('tag-new'); styleApplied = true;
            } else if (tagText.includes('換')) { patientCell.classList.add('tag-huan'); styleApplied = true;
            } else if (tagText.includes('兩')) { patientCell.classList.add('tag-liang'); styleApplied = true;
            } else if (tagText.includes('B')) { patientCell.classList.add('tag-b'); styleApplied = true;
            }
            if (styleApplied) return;
            if (tagText.includes('住') || patient.status === 'ipd') { patientCell.classList.add('hospitalized');
            } else if (patient.status === 'opd') { patientCell.classList.add('status-opd'); }
        }
        
        async function loadDataForDay(dateStr) {
            currentRecord = null;
            clearBoardUi();
            setStatus('讀取中...', 'loading');
            
            try {
                const date = new Date(dateStr + 'T00:00:00');
                const weekStartDate = getStartOfWeek(date);
                const weekStartStr = formatDate(weekStartDate);

                const [dailySchedules, weeklySchedulesRaw, patientsData] = await Promise.all([
                    schedulesApi.fetchAll(`?date=${dateStr}`),
                    weeklyScheduleApi.fetchAll(`?weekStart=${weekStartStr}`),
                    patientsApi.fetchAll()
                ]);

                allPatients = patientsData.filter(p => !p.isDeleted);
                
                let finalSchedule = {};
                let weeklyDataFound = false;

                const dayOfWeek = date.getDay();
                if (dayOfWeek !== 0 && weeklySchedulesRaw.length > 0) {
                    const weeklyDayIndex = dayOfWeek - 1;
                    const weeklyForToday = getTodaysWeeklySchedule(weeklySchedulesRaw, weeklyDayIndex);
                    if (Object.keys(weeklyForToday).length > 0) {
                        finalSchedule = weeklyForToday;
                        weeklyDataFound = true;
                    }
                }
                
                currentRecord = dailySchedules.length > 0 ? dailySchedules[0] : null;
                if (currentRecord && currentRecord.schedule) {
                    Object.assign(finalSchedule, currentRecord.schedule);
                }

                renderDataToUI(finalSchedule);
                
                if (currentRecord) {
                    setStatus('資料已從雲端載入', 'saved');
                } else {
                    setStatus(weeklyDataFound ? '已從週排班載入，尚未儲存' : '本日無週排班也無儲存記錄', 'saved');
                }
                
                updateShiftPatientCount();

            } catch (error) {
                console.error('讀取資料失敗:', error);
                setStatus('讀取或同步失敗', 'error');
                renderInpatientList();
            }
        }
        
        function getTodaysWeeklySchedule(weeklySchedulesRaw, weeklyDayIndex) {
            const todayWeekly = {};
            const patientMap = new Map(allPatients.map(p => [p.id, p]));

            weeklySchedulesRaw.forEach(item => {
                if (!item.slotId) return;
                const parts = item.slotId.split('-');
                if (parts.length < 3 || parseInt(parts[2], 10) !== weeklyDayIndex) return;
                
                const bedNumber = parts[0];
                const shiftIndex = parseInt(parts[1], 10);
                const shiftName = Object.keys(shiftToIndexMap).find(key => shiftToIndexMap[key] === shiftIndex);
                if (!shiftName) return;

                const patient = patientMap.get(item.patientId);
                if (patient) {
                    const dailyShiftId = `bed-${bedNumber}-${shiftName}`;
                    todayWeekly[dailyShiftId] = {
                        patient: patient.name
                    };
                }
            });
            return todayWeekly;
        }

        function isPatientScheduledToday(patientId) {
            const patient = allPatients.find(p => p.id === patientId);
            if (!patient) return false;
            const patientName = patient.name;
            const patientCells = document.querySelectorAll('.patient-name, .peripheral-patient-name');
            for (const cell of patientCells) {
                if (cell.textContent.trim() === patientName) { return true; }
            }
            return false;
        }

        function renderInpatientList() {
            const inpatientListEl = document.getElementById('inpatient-list');
            if (!inpatientListEl) return;
            let inpatients = allPatients.filter(p => p.status === 'ipd' && !p.isDeleted);
            const regularFreqs = ['一三五', '二四六'];
            if (inpatientFilter === '135') { inpatients = inpatients.filter(p => p.frequency === '一三五');
            } else if (inpatientFilter === '246') { inpatients = inpatients.filter(p => p.frequency === '二四六');
            } else if (inpatientFilter === 'other') { inpatients = inpatients.filter(p => !regularFreqs.includes(p.frequency)); }
            
            inpatientListEl.innerHTML = '';
            if (inpatients.length === 0) {
                inpatientListEl.innerHTML = '<li>無符合條件的住院病人</li>';
            } else {
                inpatients.forEach(p => {
                    const li = document.createElement('li');
                    if (isPatientScheduledToday(p.id)) { li.classList.add('scheduled-inpatient'); }
                    li.innerHTML = `
                        <div class="patient-info-row">
                            <span class="name">${p.name}</span>
                            <span class="freq">${p.frequency || '未設定'}</span>
                        </div>
                        <div class="patient-info-row">
                            <span class="mrn">(${p.medicalRecordNumber || '無病歷號'})</span>
                        </div>
                    `;
                    inpatientListEl.appendChild(li);
                });
            }
        }

        function renderDataToUI(scheduleData) {
            Object.keys(scheduleData).forEach(id => { 
                const row = document.querySelector(`[data-shift-id="${id}"]`); 
                if (!row) return; 
                const data = scheduleData[id]; 
                const patientCell = row.querySelector('.patient-name, .peripheral-patient-name');
                if (patientCell && data.patient) { patientCell.textContent = data.patient; }
                const bedNumberCell = row.querySelector('.peripheral-bed-number');
                if (bedNumberCell && data.bedNumber) { bedNumberCell.textContent = data.bedNumber; }
                const tagCell = row.querySelector('.patient-tag');
                if (tagCell && data.tag) { tagCell.textContent = data.tag; }
                if (patientCell && patientCell.textContent) { updatePatientCellStyle(patientCell); }
                if (row.classList.contains('split-shift')) { 
                    if(data.nurse_in) row.querySelector('.nurse-in').value = data.nurse_in; 
                    if(data.nurse_out) row.querySelector('.nurse-out').value = data.nurse_out; 
                } else { 
                    if(data.nurse) row.querySelector('.nurse-team-select').value = data.nurse; 
                } 
            });
        }

        function collectDataFromUI() {
            const scheduleData = {};
            document.querySelectorAll('.shift-row, .peripheral-shift-row').forEach(row => {
                const id = row.dataset.shiftId;
                const tag = row.querySelector('.patient-tag')?.textContent || '';
                let data = {};
                if (row.classList.contains('split-shift')) {
                    const nurseIn = row.querySelector('.nurse-in').value;
                    const nurseOut = row.querySelector('.nurse-out').value || nurseIn;
                    data = { nurse_in: nurseIn, nurse_out: nurseOut, patient: row.querySelector('.patient-name').textContent, tag, shiftId: id };
                } else if (row.classList.contains('shift-row')) {
                    data = { nurse: row.querySelector('.nurse-team-select').value, patient: row.querySelector('.patient-name').textContent, tag, shiftId: id };
                } else {
                    data = { nurse: row.querySelector('.nurse-team-select').value, bedNumber: row.querySelector('.peripheral-bed-number').textContent, patient: row.querySelector('.peripheral-patient-name').textContent, tag, shiftId: id };
                }
                if (Object.values(data).some(val => val && String(val).trim() !== '')) { scheduleData[id] = data; }
            });
            return scheduleData;
        }

        function validateNoDuplicatePatients() {
            const nameCounts = new Map();
            document.querySelectorAll('.patient-name, .peripheral-patient-name').forEach(el => {
                const name = el.textContent.trim();
                if (name) { nameCounts.set(name, (nameCounts.get(name) || 0) + 1); }
            });
            const duplicates = new Set();
            for (const [name, count] of nameCounts.entries()) { if (count > 1) { duplicates.add(name); } }
            return { isValid: duplicates.size === 0, duplicates: duplicates };
        }

        function clearAllHighlights() { document.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight')); }

        function highlightDuplicatePatients(names) { names.forEach(name => { document.querySelectorAll('.patient-name, .peripheral-patient-name').forEach(cell => { if (cell.textContent.trim() === name) { cell.closest('.shift-row, .peripheral-shift-row').classList.add('highlight'); } }); }); }

        async function deleteDailyRecord() {
            if (!currentRecord) return Promise.resolve();
            setStatus('刪除雲端記錄中...', 'loading');
            try {
                await schedulesApi.remove(currentRecord.id, currentRecord._sourceEndpoint);
                setStatus('雲端記錄已刪除', 'saved');
                currentRecord = null;
                return Promise.resolve();
            } catch (error) {
                console.error("刪除雲端記錄失敗:", error);
                setStatus('刪除失敗', 'error');
                alert('刪除雲端記錄失敗，請檢查網路連線或稍後再試。');
                return Promise.reject(error);
            }
        }
        
        async function saveDataToCloud() {
            clearAllHighlights();
            const validationResult = validateNoDuplicatePatients();
            if (!validationResult.isValid) {
                alert(`儲存失敗：病人 "${Array.from(validationResult.duplicates).join('、')}" 在今日排程中重複出現！`);
                setStatus('儲存失敗，發現重複排班', 'error');
                highlightDuplicatePatients(validationResult.duplicates);
                return;
            }
            const dailyScheduleData = collectDataFromUI();
            
            setStatus('儲存本日排程中...', 'loading');
            try {
                if (Object.keys(dailyScheduleData).length === 0) {
                    if (currentRecord) await deleteDailyRecord();
                } else {
                    const dateStr = formatDate(currentDate);
                    const dataToSave = { date: dateStr, schedule: dailyScheduleData, names: currentRecord?.names || {} };
                    
                    if (currentRecord) {
                        dataToSave._sourceEndpoint = currentRecord._sourceEndpoint;
                        const updatedRecord = await schedulesApi.update(currentRecord.id, dataToSave);
                        currentRecord = {...updatedRecord, _sourceEndpoint: dataToSave._sourceEndpoint};
                    } else {
                        currentRecord = await schedulesApi.save(dataToSave);
                    }
                }
            } catch (error) {
                console.error('儲存本日排程失敗:', error);
                setStatus('儲存本日排程失敗', 'error');
                return;
            }

            setStatus('同步至週排班中...', 'loading');
            try {
                await syncToWeeklySchedule(dailyScheduleData);
                document.querySelectorAll('.newly-synced').forEach(el => el.classList.remove('newly-synced'));
                setStatus('資料已儲存並同步至週排班', 'saved');
                alert('本日排程儲存成功，並已同步更新至週排班總表！');
            } catch (error) {
                console.error('同步週排班失敗:', error);
                setStatus('本日排程已存，但同步週排班失敗', 'error');
                alert('本日排程已儲存，但同步更新至週排班時發生錯誤，請檢查週排班總表。');
            }
        }
        
        async function syncToWeeklySchedule(dailyScheduleData) {
            const date = currentDate;
            const weekStartStr = formatDate(getStartOfWeek(date));
            const weeklyDayIndex = date.getDay() - 1;

            if (weeklyDayIndex < 0) return; 

            const allWeekSchedules = await weeklyScheduleApi.fetchAll(`?weekStart=${weekStartStr}`);
            
            const dailyPatientsOnSlot = new Map();
            const patientNameToId = new Map(allPatients.map(p => [p.name, p.id]));

            Object.values(dailyScheduleData).forEach(data => {
                if(data.shiftId) {
                    const parts = data.shiftId.split('-');
                    if (parts.length >= 3) {
                        const bedShift = `${parts[1]}-${parts[2]}`;
                        dailyPatientsOnSlot.set(bedShift, data.patient);
                    }
                }
            });

            const toDeletePromises = [];
            allWeekSchedules.forEach(ws => {
                if (ws.slotId) {
                    const parts = ws.slotId.split('-');
                    if (parseInt(parts[2], 10) === weeklyDayIndex) {
                        const shiftName = Object.keys(shiftToIndexMap).find(key => shiftToIndexMap[key] === parseInt(parts[1], 10));
                        const bedShift = `${parts[0]}-${shiftName}`;
                        if (!dailyPatientsOnSlot.has(bedShift)) {
                           toDeletePromises.push(weeklyScheduleApi.remove(ws.id, ws._sourceEndpoint));
                        }
                    }
                }
            });

            const toAddOrUpdatePromises = [];
            for (const [bedShift, patientName] of dailyPatientsOnSlot.entries()) {
                const patientId = patientNameToId.get(patientName);
                if (!patientId) continue;

                const [bedNumber, shiftName] = bedShift.split('-');
                const shiftIndex = shiftToIndexMap[shiftName];
                const weeklySlotId = `${bedNumber}-${shiftIndex}-${weeklyDayIndex}`;
                
                const existingWeeklyRecord = allWeekSchedules.find(ws => ws.slotId === weeklySlotId);

                if (existingWeeklyRecord) {
                    if (existingWeeklyRecord.patientId !== patientId) {
                        const updatedData = { ...existingWeeklyRecord, patientId };
                        toAddOrUpdatePromises.push(weeklyScheduleApi.update(existingWeeklyRecord.id, updatedData));
                    }
                } else {
                    const newData = { weekStart: weekStartStr, slotId: weeklySlotId, patientId };
                    toAddOrUpdatePromises.push(weeklyScheduleApi.save(newData));
                }
            }
            await Promise.all([...toDeletePromises, ...toAddOrUpdatePromises]);
        }
        
        async function copySchedule() {
            const sourceDateStr = document.getElementById('copy-source-date').value;
            if (!sourceDateStr) { alert("請選擇一個來源日期！"); return; }
            if (sourceDateStr === formatDate(currentDate)) { alert("來源日期與目前日期相同，無需複製。"); return; }
            if (!confirm(`確定要將 ${sourceDateStr} 的排程複製到 ${formatDate(currentDate)} 嗎？\n這會覆蓋當前畫面的所有內容！`)) return;
            setStatus(`從 ${sourceDateStr} 複製中...`, 'loading');
            try {
                const response = await schedulesApi.fetchAll(`?date=${sourceDateStr}`);
                if (response.length > 0) {
                    clearBoardUi(); 
                    currentRecord = null;
                    renderDataToUI(response[0].schedule || {});
                    updateShiftPatientCount();
                    setStatus('複製成功，請記得儲存', 'unsaved');
                } else {
                    alert(`在雲端找不到 ${sourceDateStr} 的排程資料。`);
                    setStatus('複製失敗', 'error');
                }
            } catch (error) { alert(`複製失敗: ${error.message}`); setStatus('複製失敗', 'error'); }
        }
        
        const search = () => {
            clearAllHighlights();
            const searchTerm = document.getElementById('search-input').value.trim().toUpperCase();
            if (!searchTerm) return;
            document.querySelectorAll('.shift-row, .peripheral-shift-row').forEach(row => {
                let textContent = '';
                row.querySelectorAll('select, div[contenteditable="true"]').forEach(el => { textContent += (el.tagName === 'SELECT' ? (el.value ? el.options[el.selectedIndex].text : '') : el.textContent) + ' '; });
                if (textContent.toUpperCase().includes(searchTerm)) { row.classList.add('highlight'); }
            });
        };
        
        function changeDate(days) {
            currentDate.setDate(currentDate.getDate() + days);
            updateDateDisplay();
            loadDataForDay(formatDate(currentDate));
        }
        
        function updateDateDisplay() {
            const dateStr = formatDate(currentDate);
            document.getElementById('current-date-display').textContent = dateStr;
            document.getElementById('copy-source-date').value = dateStr;
            const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
            document.getElementById('weekday-display').textContent = weekdays[currentDate.getDay()];
        }
        
        function generateLayout() {
            const leftWing = document.getElementById('left-wing');
            const rightWing = document.getElementById('right-wing');
            const peripheralContainer = document.getElementById('peripheral-bed-container');
            generateWingLayout(leftWing, layoutData.leftWingRows, 'left-wing-bed');
            generateWingLayout(rightWing, layoutData.rightWingRows, 'right-wing-bed');
            const n = document.createElement('div');
            n.className = 'bed-row';
            n.innerHTML = '<div class="nursing-station">護理站</div>';
            leftWing.appendChild(n);
            peripheralContainer.innerHTML = '';
            for (let i = 1; i <= peripheralBedCount; i++) {
                peripheralContainer.appendChild(createPeripheralBedElement(i));
            }
        }

        document.getElementById('prev-date-btn').addEventListener('click', () => changeDate(-1));
        document.getElementById('next-date-btn').addEventListener('click', () => changeDate(1));
        document.getElementById('today-btn').addEventListener('click', () => { currentDate = new Date(); updateDateDisplay(); loadDataForDay(formatDate(currentDate)); });
        document.getElementById('save-btn').addEventListener('click', saveDataToCloud);
        document.getElementById('print-btn').addEventListener('click', printSchedule);
        document.getElementById('search-btn').addEventListener('click', search);
        document.getElementById('clear-all-btn').addEventListener('click', () => {
            if (currentRecord) {
                if (confirm("偵測到本日雲端有排程資料，您要一併刪除嗎？\n\n- 按 [確定] 將會刪除雲端資料並清空畫面。\n- 按 [取消] 將只會清空目前畫面（下次載入時會重新同步）。")) {
                    deleteDailyRecord().then(() => {
                        clearBoardUi();
                    });
                } else {
                    clearBoardUi();
                }
            } else {
                if (confirm('確定要清除畫面上的所有資料嗎？')) {
                    clearBoardUi();
                }
            }
        });
        document.getElementById('copy-schedule-btn').addEventListener('click', copySchedule);
        document.addEventListener('input', (e) => {
            setStatus('內容已變更，尚未儲存', 'unsaved');
            e.target.closest('.shift-row, .peripheral-shift-row')?.classList.remove('newly-synced');
            if (e.target.classList.contains('patient-tag')) {
                const patientCell = e.target.closest('.shift-row, .peripheral-shift-row').querySelector('.patient-name, .peripheral-patient-name');
                updatePatientCellStyle(patientCell);
            } else if (e.target.matches('.patient-name, .peripheral-patient-name')) {
                updateShiftPatientCount();
                updatePatientCellStyle(e.target);
            }
        });
        
        const filterGroup = document.getElementById('filter-group');
        filterGroup.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                filterGroup.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
                inpatientFilter = e.target.dataset.filter;
                renderInpatientList();
            }
        });

        generateLayout();
        updateDateDisplay();
        loadDataForDay(formatDate(currentDate));
    });
    </script>
</body>
</html>
