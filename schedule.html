<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>洗腎室床位病人排程表 (V25.5 - 全功能最終修復版)</title>
    <style>
        /* CSS 與 V25.4 完全相同 */
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f4f7f6; padding: 20px; color: #333; }
        .controls-panel { max-width: 1800px; margin: 0 auto 20px; padding: 15px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
        #save-btn { background-color: #4CAF50; color: white; border-color: #4CAF50;}
        .date-navigator { display: flex; align-items: center; gap: 10px; margin: 0 auto; }
        #current-date-display { font-size: 1.5em; font-weight: bold; color: #333; }
        #weekday-display { font-size: 1.5em; font-weight: bold; color: #005a9c; margin-left: 10px;}
        .patient-name, .peripheral-patient-name { padding: 4px; border: none; font-size: 0.9em; text-align: center; overflow-wrap: break-word; background-color: #f8f9fa; color: #333; font-weight: bold; display: flex; align-items: center; justify-content: center; }
        .patient-name[contenteditable="true"], .peripheral-patient-name[contenteditable="true"], .peripheral-bed-number[contenteditable="true"], .patient-tag[contenteditable="true"] { background-color: #fff; }
        .patient-name[contenteditable="true"]:empty, .peripheral-patient-name[contenteditable="true"]:empty { background-color: #f0f0f0; }
        .patient-name[contenteditable="true"]:empty::before { content: "輸入病人"; color: #aaa; font-style: italic; }
        .peripheral-patient-name[contenteditable="true"]:empty::before { content: "病人名"; color: #aaa; font-style: italic; }
        .peripheral-bed-number[contenteditable="true"]:empty::before { content: "床號"; color: #aaa; font-style: italic; }
        .patient-tag:empty::before { content: "備註"; color: #aaa; font-style: italic; }
        .patient-name.tag-chou, .peripheral-patient-name.tag-chou { background-color: #90caf9 !important; }
        .patient-name.hospitalized, .peripheral-patient-name.hospitalized { background-color: #ffcdd2 !important; }
        .patient-name.tag-huan, .peripheral-patient-name.tag-huan { background-color: #e3f2fd !important; }
        .patient-name.tag-liang, .peripheral-patient-name.tag-liang { background-color: #ffcc80 !important; }
        .patient-name.tag-b, .peripheral-patient-name.tag-b { background-color: #fffde7 !important; }
        /* 其他所有 CSS 與 V25.4 一致 */
    </style>
</head>
<body>
    <!-- HTML 結構與 V25.4 完全相同 -->
    <div class="date-navigator">
        <button id="prev-date-btn" class="date-nav-btn"><</button>
        <h1 id="current-date-display"></h1>
        <span id="weekday-display"></span>
        <button id="next-date-btn" class="date-nav-btn">></button>
        <button id="today-btn">回到今日</button>
    </div>
    <div class="controls-panel">
        <button id="save-btn">儲存勤務資料</button>
        <button id="print-btn">列印排程</button>
        <button id="clear-all-btn">清除本日勤務</button>
        <input type="date" id="copy-source-date">
        <button id="copy-schedule-btn">從他日複製勤務</button>
        <div class="search-group">
            <input type="text" id="search-input" placeholder="搜尋...">
            <button id="search-btn">搜尋</button>
        </div>
        <button id="open-stats-btn">查看統計報表</button>
        <div class="shift-patient-count">
            <div>早班：<span id="early-shift-count">0</span></div>
            <div>午班：<span id="noon-shift-count">0</span></div>
            <div>晚班：<span id="late-shift-count">0</span></div>
        </div>
        <div id="status-indicator" class="status-indicator"></div>
    </div>
    <div class="dialysis-unit">
        <div class="left-wing" id="left-wing"></div>
        <div class="aisle">中 央 走 道</div>
        <div class="right-wing" id="right-wing"></div>
    </div>
    <div class="extra-sections">
        <div class="peripheral-section">
            <h2>外圍床位</h2>
            <div class="peripheral-bed-container" id="peripheral-bed-container"></div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const API = {
            patients: 'https://684eb206f0c9c9848d28d637.mockapi.io/patients',
            weeklySchedule: 'https://684eb206f0c9c9848d28d637.mockapi.io/weekly_schedule',
            dailySchedule: 'https://684eb206f0c9c9848d28d637.mockapi.io/schedules'
        };
        let currentDate = new Date();
        let currentDailyRecord = null;
        let allPatients = [];
        const SHIFTS_KEY = ['早', '午', '晚'];
        const statusIndicator = document.getElementById('status-indicator');
        const baseTeams = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', '外圍'];
        const earlyTeams = baseTeams.map(t => `早${t}`);
        const lateTeams = baseTeams.map(t => `晚${t}`);
        const allTeams = [...earlyTeams, ...lateTeams];
        const earlyOptionsHTML = `<option value=""></option>` + earlyTeams.map(team => `<option value="${team}">${team}組</option>`).join('');
        const lateOptionsHTML = `<option value=""></option>` + lateTeams.map(team => `<option value="${team}">${team}組</option>`).join('');
        const allOptionsHTML = `<option value=""></option>` + allTeams.map(team => `<option value="${team}">${team}組</option>`).join('');
        const layoutData = { leftWingRows: [['空', 32, 31], [33, 35, 36], [39, 38, 37], [51, 52, 53], [57, 56, 55], [58, 59, 61], [64, 63, 62]], rightWingRows: [[29, 28, 27], [23, 25, 26], [22, 21, 19], [16, 17, 18], [15, 13, 12], [8, 9, 11], [7, 6, 5], [1, 2, 3]] };
        const aisleSideBeds = [1, 7, 8, 15, 16, 22, 23, 29, 31, 36, 37, 53, 55, 61, 62, 64];
        const hepatitisBeds = ['空', 31, 32, 33, 35, 36];
        const peripheralBedCount = 6;
        const leftWing = document.getElementById('left-wing');
        const rightWing = document.getElementById('right-wing');
        const peripheralContainer = document.getElementById('peripheral-bed-container');

        const formatDate = (date) => date.toISOString().split('T')[0];
        const getStartOfWeek = (date) => { const d = new Date(date); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1); return new Date(new Date(d.setDate(diff)).setHours(0, 0, 0, 0)); };
        const setStatus = (message, type) => { statusIndicator.textContent = message; statusIndicator.className = `status-indicator ${type}`; };
        const printSchedule = () => window.print();

        const updateDateDisplay = () => {
            const dateStr = formatDate(currentDate);
            document.getElementById('current-date-display').textContent = dateStr;
            document.getElementById('copy-source-date').value = dateStr;
            const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
            document.getElementById('weekday-display').textContent = weekdays[currentDate.getDay()];
        };

        function generateWingLayout(container, rows, wingClass) { rows.forEach(rowBeds => { const rowDiv = document.createElement('div'); rowDiv.className = 'bed-row'; rowBeds.forEach(bedNumber => { rowDiv.appendChild(createBedElement(bedNumber, hepatitisBeds.includes(bedNumber), aisleSideBeds.includes(bedNumber), wingClass)); }); container.appendChild(rowDiv); }); }
        
        function createBedElement(bedNumber, isHepatitis, isAisleSide, wingClass) {
            if (bedNumber === null) { const p = document.createElement('div'); p.className = 'bed placeholder'; return p; }
            const bedDiv = document.createElement('div'); bedDiv.className = `bed ${wingClass}`; bedDiv.dataset.bedId = `bed-${bedNumber}`;
            if (isAisleSide) bedDiv.classList.add('aisle-side'); if (isHepatitis) bedDiv.classList.add('hepatitis'); if (bedNumber === '空') bedDiv.classList.add('unassigned');
            let headerText = `床號 ${bedNumber}`; if (bedNumber === '空') headerText = '未排床'; else if (isHepatitis) headerText += ' (BC肝炎)';
            const shiftRowsHTML = ['早', '午', '晚'].map(shift => {
                const shiftId = `bed-${bedNumber}-${shift}`;
                if (shift === '午') { return `<div class="shift-row split-shift" data-shift-id="${shiftId}"><div class="shift-label">午</div><div class="nurse-split-column"><select class="nurse-team-select nurse-in" data-team-id="早${bedNumber}"><option value="">上針</option>${earlyOptionsHTML}</select><select class="nurse-team-select nurse-out" data-team-id="晚${bedNumber}"><option value="">收針</option>${allOptionsHTML}</select></div><div class="patient-name" contenteditable="false"></div><div class="patient-tag" contenteditable="true"></div></div>`; }
                else { const options = shift === '早' ? earlyOptionsHTML : lateOptionsHTML; return `<div class="shift-row" data-shift-id="${shiftId}"><div class="shift-label">${shift}</div><select class="nurse-team-select" data-team-id="${shift}${bedNumber}"><option value="">-</option>${options}</select><div class="patient-name" contenteditable="false"></div><div class="patient-tag" contenteditable="true"></div></div>`; }
            }).join('');
            bedDiv.innerHTML = `<div class="bed-header">${headerText}</div>${bedNumber !== '空' ? shiftRowsHTML : ''}`;
            return bedDiv;
        }

        function createPeripheralBedElement(index) {
            const bedDiv = document.createElement('div'); bedDiv.className = 'peripheral-bed';
            const shiftRowsHTML = ['早', '午', '晚'].map(shift => {
                let options; switch (shift) { case '早': options = earlyOptionsHTML; break; case '晚': options = lateOptionsHTML; break; case '午': options = allOptionsHTML; break; }
                return `<div class="peripheral-shift-row" data-shift-id="peripheral-${index}-${shift}"><div class="shift-label">${shift}</div><select class="nurse-team-select" data-team-id="${shift}外圍${index}"><option value="">-</option>${options}</select><div class="peripheral-bed-number" contenteditable="true"></div><div class="peripheral-patient-name" contenteditable="true"></div><div class="patient-tag" contenteditable="true"></div></div>`;
            }).join('');
            bedDiv.innerHTML = `<div class="peripheral-header">外圍床位 ${index}</div>${shiftRowsHTML}`;
            return bedDiv;
        }

        function clearBoard(clearPatients = true) {
            if (clearPatients) {
                document.querySelectorAll('.patient-name, .peripheral-patient-name, .peripheral-bed-number').forEach(el => el.textContent = '');
            }
            document.querySelectorAll('.nurse-team-select, .patient-tag').forEach(el => { el.value = ''; el.textContent = ''; });
            document.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight'));
            document.querySelectorAll('.patient-name[class*="tag-"], .peripheral-patient-name[class*="tag-"]').forEach(el => {
                const isManual = el.classList.contains('manual-input');
                el.className = 'patient-name' + (isManual ? ' manual-input' : '');
            });
            currentDailyRecord = null;
            updateShiftPatientCount();
            setStatus('新排程，尚未儲存', 'unsaved');
        }

        async function loadDataFromCloud(date) {
            clearBoard(true);
            setStatus('讀取中...', 'loading');
            try {
                const dayOfWeek = date.getDay() === 0 ? 6 : date.getDay() - 1;
                const weekStartDate = getStartOfWeek(date);
                const [patientsRes, weeklyScheduleRes, dailyRecordRes] = await Promise.all([
                    fetch(API.patients),
                    fetch(`${API.weeklySchedule}?weekStart=${formatDate(weekStartDate)}`),
                    fetch(`${API.dailySchedule}?date=${formatDate(date)}`)
                ]);
                if (!patientsRes.ok || !weeklyScheduleRes.ok || !dailyRecordRes.ok) throw new Error('API fetch failed');
                allPatients = await patientsRes.json();
                const weeklySchedules = await weeklyScheduleRes.json();
                const dailyRecords = await dailyRecordRes.json();
                currentDailyRecord = dailyRecords.length > 0 ? dailyRecords[0] : null;

                const todaySchedules = weeklySchedules.filter(s => s.slotId.split('-')[2] == dayOfWeek);
                renderDataToUI(todaySchedules, currentDailyRecord ? currentDailyRecord.duties : {}, currentDailyRecord ? currentDailyRecord.names : {});
                setStatus('資料已載入', 'saved');
            } catch (error) { console.error("載入資料失敗:", error); setStatus('載入失敗', 'error'); }
        }
        
        function renderDataToUI(schedules, duties, names) {
            // 先填入週排班的病人
            schedules.forEach(schedule => {
                const patient = allPatients.find(p => p.id === schedule.patientId);
                if (!patient) return;
                const [bed, shiftIndex] = schedule.slotId.split('-');
                const shift = SHIFTS_KEY[shiftIndex];
                const slotId = `bed-${bed}-${shift}`;
                const row = document.querySelector(`[data-shift-id="${slotId}"]`);
                if (!row) return;
                const patientCell = row.querySelector('.patient-name');
                if (patientCell) { patientCell.textContent = patient.name; }
            });
            // 再填入當日勤務資料
            Object.keys(duties).forEach(slotId => {
                const row = document.querySelector(`[data-shift-id="${slotId}"]`);
                if (!row) return;
                const duty = duties[slotId];
                if (duty.nurse) { row.querySelector('.nurse-team-select').value = duty.nurse; }
                if (duty.nurse_in) { row.querySelector('.nurse-in').value = duty.nurse_in; }
                if (duty.nurse_out) { row.querySelector('.nurse-out').value = duty.nurse_out; }
                if (duty.tag) { row.querySelector('.patient-tag').textContent = duty.tag; }
                if (slotId.startsWith('peripheral-')) {
                    if (duty.bedNumber) { row.querySelector('.peripheral-bed-number').textContent = duty.bedNumber; }
                    if (duty.patient) { row.querySelector('.peripheral-patient-name').textContent = duty.patient; }
                }
            });
             // 最後填入護理師姓名
            if(names) {
                Object.keys(names).forEach(teamId => {
                    document.querySelectorAll(`.nurse-team-select[data-team-id^="${teamId}"]`).forEach(select => {
                        select.value = names[teamId];
                    });
                });
            }
            document.querySelectorAll('.patient-tag').forEach(checkTagStatus);
            updateShiftPatientCount();
        }

        const checkTagStatus = (tagElement) => {
            const parentRow = tagElement.closest('.shift-row, .peripheral-shift-row');
            if (!parentRow) return;
            const patientCell = parentRow.querySelector('.patient-name, .peripheral-patient-name');
            if (patientCell) {
                const tagText = tagElement.textContent.toUpperCase();
                patientCell.classList.remove('tag-chou', 'hospitalized', 'tag-huan', 'tag-liang', 'tag-b');
                if (tagText.includes('抽')) { patientCell.classList.add('tag-chou'); }
                else if (tagText.includes('住')) { patientCell.classList.add('hospitalized'); }
                else if (tagText.includes('換')) { patientCell.classList.add('tag-huan'); }
                else if (tagText.includes('兩')) { patientCell.classList.add('tag-liang'); }
                else if (tagText.includes('B')) { patientCell.classList.add('tag-b'); }
            }
        };

        const collectDutyData = () => { const dutyData = { duties: {}, names: {} }; document.querySelectorAll('.shift-row, .peripheral-shift-row').forEach(row => { const slotId = row.dataset.shiftId; const duty = {}; const tag = row.querySelector('.patient-tag')?.textContent.trim(); if (tag) duty.tag = tag; if (row.classList.contains('split-shift')) { const nurseIn = row.querySelector('.nurse-in').value; const nurseOut = row.querySelector('.nurse-out').value; if(nurseIn) duty.nurse_in = nurseIn; if(nurseOut) duty.nurse_out = nurseOut; } else { const nurse = row.querySelector('.nurse-team-select').value; if(nurse) duty.nurse = nurse; } if (slotId.startsWith('peripheral-')) { const bedNum = row.querySelector('.peripheral-bed-number')?.textContent.trim(); const patientName = row.querySelector('.peripheral-patient-name')?.textContent.trim(); if(bedNum) duty.bedNumber = bedNum; if(patientName) duty.patient = patientName; } if (Object.keys(duty).length > 0) { dutyData.duties[slotId] = duty; } }); document.querySelectorAll('.nurse-team-select').forEach(select => { if(select.value) { const teamId = select.dataset.teamId; if(teamId) dutyData.names[teamId] = select.value; }}); return dutyData; };

        async function saveDataToCloud() {
            const dutyData = collectDutyData();
            const dateStr = formatDate(currentDate);
            const dataToSave = { date: dateStr, duties: dutyData.duties, names: dutyData.names };
            setStatus('儲存中...', 'loading');
            try {
                const method = currentDailyRecord ? 'PUT' : 'POST';
                const url = currentDailyRecord ? `${API.dailySchedule}/${currentDailyRecord.id}` : API.dailySchedule;
                const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dataToSave) });
                if (!response.ok) throw new Error('Save error');
                currentDailyRecord = await response.json();
                setStatus(`勤務資料已於 ${new Date().toLocaleTimeString()} 儲存成功`, 'saved');
            } catch (error) { console.error('儲存失敗:', error); setStatus('儲存失敗', 'error'); }
        }

        async function copySchedule() {
            const sourceDateStr = document.getElementById('copy-source-date').value;
            if (!sourceDateStr || sourceDateStr === formatDate(currentDate)) return;
            if (!confirm(`確定要將 ${sourceDateStr} 的勤務資料複製到今天嗎？\n這會覆蓋今天的勤務資料。`)) return;
            setStatus(`從 ${sourceDateStr} 複製中...`, 'loading');
            try {
                const response = await fetch(`${API.dailySchedule}?date=${sourceDateStr}`);
                if (!response.ok) throw new Error(`找不到來源日期的資料`);
                const data = await response.json();
                if (data.length > 0) {
                    clearBoard(false);
                    renderDataToUI([], data[0].duties || {}, data[0].names || {});
                    setStatus('複製成功，請記得儲存', 'unsaved');
                } else { alert(`找不到 ${sourceDateStr} 的勤務資料。`); setStatus('複製失敗', 'error'); }
            } catch (error) { alert(`複製失敗: ${error.message}`); setStatus('複製失敗', 'error'); }
        }

        function openStatsPage() { const dateStr = formatDate(currentDate); if (window.parent && window.parent.navigateTo) { window.parent.navigateTo(`stats.html?date=${dateStr}`); } else { window.open(`stats.html?date=${dateStr}`, '_blank'); } }
        function changeDate(days) { currentDate.setDate(currentDate.getDate() + days); updateDateDisplay(); loadDataFromCloud(currentDate); }
        
        document.getElementById('prev-date-btn').addEventListener('click', () => changeDate(-1));
        document.getElementById('next-date-btn').addEventListener('click', () => changeDate(1));
        document.getElementById('today-btn').addEventListener('click', () => { currentDate = new Date(); updateDateDisplay(); loadDataFromCloud(currentDate); });
        document.getElementById('save-btn').addEventListener('click', saveDataToCloud);
        document.getElementById('print-btn').addEventListener('click', printSchedule);
        document.getElementById('open-stats-btn').addEventListener('click', openStatsPage);
        document.getElementById('clear-all-btn').addEventListener('click', () => { if(confirm('確定要清除畫面上的所有勤務資料嗎？(此操作不會影響自動帶入的排班，需儲存後生效)')) { clearBoard(false); setStatus('畫面已清空，點擊儲存以上傳變更', 'unsaved');} });
        document.getElementById('copy-schedule-btn').addEventListener('click', copySchedule);
        document.addEventListener('input', (e) => { setStatus('內容已變更，尚未儲存', 'unsaved'); if (e.target.classList.contains('patient-tag')) { checkTagStatus(e.target); } else if (e.target.matches('.patient-name, .peripheral-patient-name, .peripheral-bed-number')) { updateShiftPatientCount(); } });
        
        generateWingLayout(leftWing, layoutData.leftWingRows, 'left-wing-bed');
        generateWingLayout(rightWing, layoutData.rightWingRows, 'right-wing-bed');
        const nursingStationRow = document.createElement('div'); nursingStationRow.className = 'bed-row'; nursingStationRow.innerHTML = '<div class="nursing-station">護理站</div>'; leftWing.appendChild(nursingStationRow);
        for (let i = 1; i <= peripheralBedCount; i++) { peripheralContainer.appendChild(createPeripheralBedElement(i)); }
        
        updateDateDisplay();
        loadDataFromCloud(currentDate);
    });
    </script>
</body>
</html>
