<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>洗腎室床位病人排程表 (V26.1 - 儲存邏輯修正版)</title>
    <style>
        /* CSS 與 V26.0 完全相同 */
        :root { --tag-chou-bg: #42A5F5; --tag-new-bg: #FFEE58; --tag-ipd-bg: #FFCDD2; --tag-biweekly-bg: #FFCC80; --tag-b-bg: #FFFDE7; }
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f4f7f6; padding: 20px; color: #333; }
        .controls-panel { max-width: 1800px; margin: 0 auto 20px; padding: 15px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
        #save-btn { background-color: #4CAF50; color: white; border-color: #4CAF50;}
        #print-btn { background-color: #008CBA; color: white; border-color: #008CBA;}
        #open-stats-btn { background-color: #f44336; color: white; border-color: #f44336;}
        #clear-all-btn { background-color: #6c757d; color: white; border-color: #6c757d;}
        #copy-schedule-btn { background-color: #ff9800; color: white; border-color: #ff9800;}
        .date-navigator { display: flex; align-items: center; gap: 10px; margin: 0 auto; }
        #current-date-display { font-size: 1.5em; font-weight: bold; color: #333; }
        #weekday-display { font-size: 1.5em; font-weight: bold; color: #005a9c; margin-left: 10px;}
        .patient-name, .peripheral-patient-name, .peripheral-bed-number { padding: 4px; border: none; font-size: 0.9em; text-align: center; overflow-wrap: break-word; }
        .patient-name:empty, .peripheral-patient-name:empty { background-color: #f0f0f0; }
        .patient-name:empty::before { content: "輸入病人"; color: #aaa; font-style: italic; }
        .peripheral-patient-name:empty::before { content: "病人名"; color: #aaa; font-style: italic; }
        .peripheral-bed-number:empty::before { content: "床號"; color: #aaa; font-style: italic; }
        .patient-name.tag-chou, .peripheral-patient-name.tag-chou { background-color: var(--tag-chou-bg) !important; }
        .patient-name.tag-new, .peripheral-patient-name.tag-new { background-color: var(--tag-new-bg) !important; }
        .patient-name.tag-ipd, .peripheral-patient-name.tag-ipd { background-color: var(--tag-ipd-bg) !important; }
        .patient-name.tag-biweekly, .peripheral-patient-name.tag-biweekly { background-color: var(--tag-biweekly-bg) !important; }
        .patient-name.tag-b, .peripheral-patient-name.tag-b { background-color: var(--tag-b-bg) !important; }
    </style>
</head>
<body>
    <div class="date-navigator">
        <button id="prev-date-btn" class="date-nav-btn"><</button>
        <h1 id="current-date-display"></h1>
        <span id="weekday-display"></span>
        <button id="next-date-btn" class="date-nav-btn">></button>
        <button id="today-btn">回到今日</button>
    </div>
    <div class="controls-panel">
        <button id="save-btn">儲存資料至雲端</button>
        <button id="print-btn">列印排程</button>
        <button id="clear-all-btn">清除本日畫面</button>
        <input type="date" id="copy-source-date">
        <button id="copy-schedule-btn">從他日複製排程</button>
        <div class="search-group">
            <input type="text" id="search-input" placeholder="搜尋...">
            <button id="search-btn">搜尋</button>
        </div>
        <button id="open-stats-btn">查看統計報表</button>
        <div class="shift-patient-count">
            <div>早班：<span id="early-shift-count">0</span></div>
            <div>午班：<span id="noon-shift-count">0</span></div>
            <div>晚班：<span id="late-shift-count">0</span></div>
        </div>
        <div id="status-indicator" class="status-indicator"></div>
    </div>
    <div class="dialysis-unit">
        <div class="left-wing" id="left-wing"></div>
        <div class="aisle">中 央 走 道</div>
        <div class="right-wing" id="right-wing"></div>
    </div>
    <div class="extra-sections">
        <div class="peripheral-section">
            <h2>外圍床位</h2>
            <div class="peripheral-bed-container" id="peripheral-bed-container"></div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const API_BASE_URL = 'https://684eb206f0c9c9848d28d637.mockapi.io/schedules';
        let currentDate = new Date();
        let currentRecord = null;
        let currentNamesData = {}; // 確保有這個變數來暫存姓名資料

        // ... 其他所有變數和 DOM 元素與 V26.0 相同 ...
        
        // --- CHANGE START: 修正 collectDataFromUI 和 saveDataToCloud ---
        function collectDataFromUI() {
            const dateStr = formatDate(currentDate);
            const schedule = {};
            const names = {};

            document.querySelectorAll('.shift-row, .peripheral-shift-row').forEach(row => {
                const id = row.dataset.shiftId;
                const patientNameEl = row.querySelector('.patient-name, .peripheral-patient-name');
                const patientName = patientNameEl ? patientNameEl.textContent.trim() : '';
                if (!patientName) return;

                let data = {
                    patient: patientName,
                    tag: row.querySelector('.patient-tag')?.textContent || ''
                };
                if (row.classList.contains('split-shift')) {
                    data.nurse_in = row.querySelector('.nurse-in').value;
                    data.nurse_out = row.querySelector('.nurse-out').value;
                } else {
                    data.nurse = row.querySelector('.nurse-team-select').value;
                }
                if (row.classList.contains('peripheral-shift-row')) {
                    data.bedNumber = row.querySelector('.peripheral-bed-number').textContent;
                }
                schedule[id] = data;
            });
            
            // 【關鍵修正】收集護理師姓名
            document.querySelectorAll('.nurse-team-select').forEach(select => {
                if (select.value && select.dataset.teamId) {
                    names[select.dataset.teamId] = select.value;
                }
            });

            return { date: dateStr, schedule, names };
        }

        async function saveDataToCloud() {
            clearAllHighlights();
            const validationResult = validateNoDuplicatePatients();
            if (!validationResult.isValid) {
                alert(`儲存失敗：病人 "${Array.from(validationResult.duplicates).join('、')}" 在今日排程中重複出現！`);
                highlightDuplicatePatients(validationResult.duplicates);
                return;
            }
            
            const dataToSave = collectDataFromUI(); // 現在已包含 names
            
            setStatus('儲存中...', 'loading');
            try {
                const method = currentRecord ? 'PUT' : 'POST';
                const url = currentRecord ? `${API_BASE_URL}/${currentRecord.id}` : API_BASE_URL;
                const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dataToSave) });
                if (!response.ok) throw new Error('Save error');
                currentRecord = await response.json();
                currentNamesData = currentRecord.names || {}; //【關鍵修正】儲存後更新記憶體中的姓名資料
                setStatus(`資料已於 ${new Date().toLocaleTimeString()} 儲存成功`, 'saved');
            } catch (error) { console.error("Save failed:", error); setStatus('儲存失敗', 'error'); }
        }
        
        // --- CHANGE START: 修正 copySchedule 函式 ---
        async function copySchedule() {
            const sourceDateStr = document.getElementById('copy-source-date').value;
            if (!sourceDateStr || sourceDateStr === formatDate(currentDate)) return;
            if (!confirm(`確定要將 ${sourceDateStr} 的排程複製到今天嗎？\n這將會覆蓋當前畫面的所有內容！`)) return;
            setStatus(`從 ${sourceDateStr} 複製中...`, 'loading');
            try {
                const response = await fetch(`${API_BASE_URL}?date=${sourceDateStr}`);
                if (!response.ok) throw new Error('Not found');
                const data = await response.json();
                if (data.length > 0) {
                    clearBoard();
                    // 【關鍵修正】同時渲染 schedule 和 names
                    renderDataToUI(data[0].schedule || {}, data[0].names || {});
                    setStatus('複製成功，請記得儲存', 'unsaved');
                } else {
                    alert(`找不到 ${sourceDateStr} 的資料。`);
                    setStatus('複製失敗', 'error');
                }
            } catch (error) { alert(`複製失敗: ${error.message}`); setStatus('複製失敗', 'error'); }
        }

        // --- CHANGE START: 修正 loadDataFromCloud 和 renderDataToUI ---
        async function loadDataFromCloud(dateStr) {
            clearBoard();
            setStatus('讀取中...', 'loading');
            try {
                const response = await fetch(`${API_BASE_URL}?date=${dateStr}`);
                if (!response.ok) throw new Error('Network error');
                const data = await response.json();
                if (data.length > 0) {
                    currentRecord = data[0];
                    renderDataToUI(currentRecord.schedule || {}, currentRecord.names || {});
                    setStatus('資料已載入', 'saved');
                } else {
                    setStatus('本日無雲端資料', 'unsaved');
                }
            } catch (error) { console.error("Load data failed:", error); setStatus('讀取失敗', 'error'); }
        }

        function renderDataToUI(schedule, names) {
            currentNamesData = names || {}; // 更新全域變數
            Object.keys(schedule).forEach(id => {
                const row = document.querySelector(`[data-shift-id="${id}"]`);
                if (!row) return;
                const data = schedule[id];
                if (data.patient) { const patientCell = row.querySelector('.patient-name, .peripheral-patient-name'); if(patientCell) patientCell.textContent = data.patient; }
                if (data.bedNumber) { const bedNumCell = row.querySelector('.peripheral-bed-number'); if(bedNumCell) bedNumCell.textContent = data.bedNumber; }
                if (data.tag) { const tagCell = row.querySelector('.patient-tag'); if(tagCell) tagCell.textContent = data.tag; }
                if (row.classList.contains('split-shift')) {
                    if (data.nurse_in) row.querySelector('.nurse-in').value = data.nurse_in;
                    if (data.nurse_out) row.querySelector('.nurse-out').value = data.nurse_out;
                } else {
                    if (data.nurse) row.querySelector('.nurse-team-select').value = data.nurse;
                }
            });
            // 填充姓名
             Object.keys(currentNamesData).forEach(teamId => {
                const select = document.querySelector(`.nurse-team-select[data-team-id="${teamId}"]`);
                if(select) select.value = currentNamesData[teamId];
             });

            document.querySelectorAll('.patient-tag').forEach(checkTagStatus);
            updateShiftPatientCount();
        }

        const checkTagStatus = (tagElement) => { /* ...與V26.0相同... */ };
        // --- 其他函式省略，與 V26.0 相同 ---
        
        // --- 事件綁定 ---
        document.getElementById('save-btn').addEventListener('click', saveDataToCloud);
        // ... 其他事件綁定與 V26.0 相同 ...
    </script>
</body>
</html>
