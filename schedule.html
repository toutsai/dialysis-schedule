<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>洗腎室床位病人排程表 (V31.1 - 渲染邏輯修正版)</title>
    <style>
        /* CSS is unchanged */
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f4f7f6; padding: 20px; color: #333; }
        /* ... a lot of styles ... */
        .patient-name.status-opd, .peripheral-patient-name.status-opd { background-color: #e8f5e9 !important; }
        .inpatient-sidebar { width: 240px; flex-shrink: 0; background-color: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6; max-height: 80vh; display: flex; flex-direction: column;}
        .inpatient-sidebar h3 { margin-top: 0; text-align: center; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; margin-bottom: 10px; }
        .filter-group { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
        .filter-group button { padding: 4px 8px; font-size: 0.8em; flex-grow: 1; border: 1px solid #ccc; background-color: #fff; cursor: pointer;}
        .filter-group button:hover { background-color: #f0f0f0; }
        .filter-group button.active { background-color: #007bff; color: white; border-color: #007bff; }
        #inpatient-list { list-style-type: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        #inpatient-list li { background-color: #fff; border: 1px solid #e0e0e0; padding: 8px 12px; margin-bottom: 8px; border-radius: 5px; display: flex; flex-direction: column; align-items: flex-start; gap: 4px; transition: background-color 0.3s; }
        #inpatient-list li.scheduled-inpatient { background-color: #fff59d; border-left: 5px solid #007bff; }
        .patient-info-row { display: flex; justify-content: space-between; width: 100%; align-items: center; }
        #inpatient-list li .name { font-weight: bold; font-size: 1.1em; }
        #inpatient-list li .mrn { font-size: 0.85em; color: #6c757d; }
        #inpatient-list li .freq { font-size: 0.9em; color: #555; background-color: #e9ecef; padding: 2px 6px; border-radius: 10px; }
        @media print { /* CSS for printing is unchanged */ }
    </style>
</head>
<body>
    <!-- HTML structure is unchanged -->
    <div class="date-navigator">
        <!-- ... -->
    </div>
    <div class="controls-panel">
        <!-- ... -->
    </div>
    <div class="main-container">
        <!-- ... -->
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const API = {
            daily_records: 'https://6852ef850594059b23cfaa4f.mockapi.io/daily_records',
            patients: 'https://6852ef850594059b23cfaa4f.mockapi.io/patients'
        };
        // Global variables are unchanged
        let currentDate = new Date();
        let currentRecord = null; 
        let allPatients = [];
        let inpatientFilter = 'all';

        // Unchanged constants
        const statusIndicator = document.getElementById('status-indicator');
        const baseTeams = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', '外圍'];
        const earlyTeams = baseTeams.map(t => `早${t}`);
        const lateTeams = baseTeams.map(t => `晚${t}`);
        // ... and other constants

        // Unchanged helper functions
        const formatDate = (date) => { /* ... */ };
        const setStatus = (message, type) => { /* ... */ };
        const updateDateDisplay = () => { /* ... */ };
        
        // Unchanged UI generation functions
        function generateLayout() { /* ... */ }
        function generateWingLayout(container, rows, wingClass) { /* ... */ }
        function createBedElement(bedNumber, isHepatitis, isAisleSide, wingClass) { /* ... */ }
        function createPeripheralBedElement(index) { /* ... */ }

        // Unchanged simple helper functions
        function clearBoardUi() { /* ... */ }
        const updateShiftPatientCount = () => { /* ... */ };
        function updatePatientCellStyle(patientCell) { /* ... */ }
        
        async function loadDailyRecord(dateStr) {
            // This function from the previous step is correct and unchanged
            currentRecord = null;
            clearBoardUi();
            setStatus('讀取中...', 'loading');
            
            try {
                const [patientsRes, dailyRecordRes] = await Promise.all([
                    fetch(API.patients),
                    fetch(`${API.daily_records}?date=${dateStr}`)
                ]);

                if (!patientsRes.ok || !dailyRecordRes.ok) throw new Error('一個或多個API請求失敗');

                allPatients = (await patientsRes.json()).filter(p => !p.isDeleted);
                const records = await dailyRecordRes.json();

                if (records.length > 0) {
                    currentRecord = records[0];
                    renderDataToUI(currentRecord.schedule || {});
                    setStatus('資料已載入', 'saved');
                } else {
                    setStatus('本日無排班資料', 'saved');
                }
                
                updateShiftPatientCount();
                renderInpatientList();

            } catch (error) {
                console.error('讀取資料失敗:', error);
                setStatus('讀取失敗', 'error');
                renderInpatientList();
            }
        }

        // --- CHANGE START: Corrected renderDataToUI function ---
        function renderDataToUI(scheduleData) {
            for (const slotKey in scheduleData) {
                const data = scheduleData[slotKey];
                const patient = allPatients.find(p => p.id === data.patientId);
                if (!patient) continue; 

                // Deconstruct the key and correctly reconstruct the DOM `data-shift-id`
                let shiftId;
                const parts = slotKey.split('-');
                const shiftIndex = parts.pop();
                const shiftName = Object.keys(shiftToIndexMap).find(key => shiftToIndexMap[key] === parseInt(shiftIndex));
                if (!shiftName) continue;

                const baseId = parts.join('-'); // This will be "12" or "peripheral-1"
                
                if (baseId.startsWith('peripheral')) {
                    shiftId = `${baseId}-${shiftName}`;
                } else {
                    shiftId = `bed-${baseId}-${shiftName}`;
                }

                const row = document.querySelector(`[data-shift-id="${shiftId}"]`);
                if (!row) continue;

                const patientCell = row.querySelector('.patient-name, .peripheral-patient-name');
                if (patientCell) patientCell.textContent = patient.name;
                
                // Handle peripheral bed number specifically
                if (baseId.startsWith('peripheral')) {
                    const bedNumberCell = row.querySelector('.peripheral-bed-number');
                    if (bedNumberCell && data.bedNumber) {
                        bedNumberCell.textContent = data.bedNumber;
                    }
                }

                const tagCell = row.querySelector('.patient-tag');
                if (tagCell && data.tag) { tagCell.textContent = data.tag; }
                if (patientCell.textContent) { updatePatientCellStyle(patientCell); }

                if (row.classList.contains('split-shift')) { 
                    if(data.nurse_in) row.querySelector('.nurse-in').value = data.nurse_in; 
                    if(data.nurse_out) row.querySelector('.nurse-out').value = data.nurse_out; 
                } else { 
                    if(data.nurse) row.querySelector('.nurse-team-select').value = data.nurse; 
                }
            }
        }
        // --- CHANGE END ---

        // --- CHANGE START: Corrected collectDataFromUI function ---
        function collectDataFromUI() {
            const schedule = {};
            document.querySelectorAll('.shift-row, .peripheral-shift-row').forEach(row => {
                const shiftId = row.dataset.shiftId; // e.g., "bed-1-早" or "peripheral-1-早"
                const patientName = (row.querySelector('.patient-name, .peripheral-patient-name') || {}).textContent || '';
                
                if (patientName.trim() !== '') {
                    const patient = allPatients.find(p => p.name === patientName.trim());
                    if(!patient) return;

                    let slotKey;
                    const parts = shiftId.split('-');
                    const shiftName = parts.pop();
                    const shiftIndex = shiftToIndexMap[shiftName];
                    const baseId = parts.join('-'); // e.g., "bed-1" or "peripheral-1"
                    
                    if (baseId.startsWith('bed-')) {
                        const bedNumber = baseId.substring(4);
                        slotKey = `${bedNumber}-${shiftIndex}`;
                    } else if (baseId.startsWith('peripheral-')) {
                        slotKey = `${baseId}-${shiftIndex}`;
                    } else {
                        return; // Unknown format
                    }
                    
                    const tag = row.querySelector('.patient-tag')?.textContent || '';
                    let slotData = { patientId: patient.id, tag };
                    
                    if (row.classList.contains('split-shift')) {
                        const nurseIn = row.querySelector('.nurse-in').value;
                        const nurseOut = row.querySelector('.nurse-out').value || nurseIn; // Default to nurseIn
                        if(nurseIn) slotData.nurse_in = nurseIn;
                        if(nurseOut) slotData.nurse_out = nurseOut;
                    } else {
                        const nurse = row.querySelector('.nurse-team-select').value;
                        if(nurse) slotData.nurse = nurse;
                    }

                    if (row.classList.contains('peripheral-shift-row')) {
                        slotData.bedNumber = row.querySelector('.peripheral-bed-number').textContent;
                    }

                    schedule[slotKey] = slotData;
                }
            });
            return schedule;
        }
        // --- CHANGE END ---

        // Unchanged functions from here...
        async function saveDataToCloud() { /* ... */ }
        async function deleteDailyRecord() { /* ... */ }
        async function copySchedule() { /* ... */ }
        function changeDate(days) { /* ... */ }

        // All other helpers and listeners are unchanged...
        function isPatientScheduledToday(patientId) { /* ... */ }
        function renderInpatientList() { /* ... */ }
        // ... etc.

        // Initialize the page
        generateLayout();
        updateDateDisplay();
        loadDailyRecord(formatDate(currentDate));

        // Setup all event listeners
        document.getElementById('prev-date-btn').addEventListener('click', () => changeDate(-1));
        document.getElementById('next-date-btn').addEventListener('click', () => changeDate(1));
        document.getElementById('today-btn').addEventListener('click', () => { currentDate = new Date(); updateDateDisplay(); loadDailyRecord(formatDate(currentDate)); });
        document.getElementById('save-btn').addEventListener('click', saveDataToCloud);
        //... and the rest of the event listeners
    });
    </script>
</body>
</html>
