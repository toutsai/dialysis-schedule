<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>洗腎室床位病人排程表 (V31.4 - 多源病人數據讀取修正版)</title>
    <style>
        /* CSS is unchanged */
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f4f7f6; padding: 20px; color: #333; }
        .controls-panel { max-width: 1800px; margin: 0 auto 20px; padding: 15px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
        #save-btn { background-color: #4CAF50; color: white; border-color: #4CAF50;}
        #print-btn { background-color: #008CBA; color: white; border-color: #008CBA;}
        #clear-all-btn { background-color: #f44336; color: white; border-color: #f44336;}
        #copy-schedule-btn { background-color: #ff9800; color: white; border-color: #ff9800;}
        .disease-tag-display { color: #c62828; font-weight: bold; margin-right: 4px; }
        /* ... other styles are unchanged ... */
        @media print { /* ... */ }
    </style>
</head>
<body>
    <!-- HTML is unchanged -->
    <div class="date-navigator">
        <!-- ... -->
    </div>
    <div class="controls-panel">
        <!-- ... -->
    </div>
    <div class="main-container">
        <!-- ... -->
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const API = {
            daily_records: 'https://6852ef850594059b23cfaa4f.mockapi.io/daily_records',
            // --- CHANGE START: Define all patient endpoints ---
            patients_ipd: 'https://6852ef850594059b23cfaa4f.mockapi.io/patients_ipd',
            patients_opd_1: 'https://6852ef850594059b23cfaa4f.mockapi.io/patients_opd_1',
            patients_opd_2: 'https://6852ef850594059b23cfaa4f.mockapi.io/patients_opd_2',
            patients_opd_3: 'https://6852ef850594059b23cfaa4f.mockapi.io/patients_opd_3'
            // We don't need to fetch 'deleted' patients for the schedule view
            // --- CHANGE END ---
        };
        const DISEASE_ABBR_MAP = { 'HIV': 'H', 'RPR': 'R', 'HBV': 'B', 'HCV': 'C', '隔離': '隔' };
        let currentDate = new Date();
        let currentRecord = null;
        let allPatients = [];
        let inpatientFilter = 'all';

        // ... All other constants and global variables are unchanged ...
        const statusIndicator = document.getElementById('status-indicator');
        // ...
        
        const formatDate = (date) => { const year = date.getFullYear(); const month = (d.getMonth() + 1).toString().padStart(2, '0'); const day = d.getDate().toString().padStart(2, '0'); return `${year}-${month}-${day}`; };
        const setStatus = (message, type) => { statusIndicator.textContent = message; statusIndicator.className = `status-indicator ${type}`; };
        const printSchedule = () => window.print();

        const updateDateDisplay = () => { /* ... unchanged ... */ };
        
        function generateLayout() { /* ... unchanged ... */ }
        function generateWingLayout(container, rows, wingClass) { /* ... unchanged ... */ }
        function createBedElement(bedNumber, isHepatitis, isAisleSide, wingClass) { /* ... unchanged ... */ }
        function createPeripheralBedElement(index) { /* ... unchanged ... */ }
        
        function clearBoardUi() { /* ... unchanged ... */ }
        const updateShiftPatientCount = () => { /* ... unchanged ... */ };
        function updatePatientCellStyle(patientCell, tagText = '') { /* ... unchanged ... */ }
        
        // --- CHANGE START: New unified function to fetch all necessary patients ---
        async function fetchAllActivePatients() {
            const patientEndpoints = [
                API.patients_ipd,
                API.patients_opd_1,
                API.patients_opd_2,
                API.patients_opd_3,
            ];

            try {
                const fetchPromises = patientEndpoints.map(url => 
                    fetch(url).then(res => {
                        if (!res.ok) {
                            console.error(`Failed to fetch from ${url}`);
                            return [];
                        }
                        return res.json();
                    })
                );
                const results = await Promise.all(fetchPromises);
                // The filter `!p.isDeleted` is still a good safeguard.
                allPatients = [].concat(...results).filter(p => p.isDeleted !== true);
            } catch (error) {
                console.error("Failed to fetch all patient data:", error);
                alert("讀取所有病人資料失敗，部分功能可能異常。");
                allPatients = [];
            }
        }
        // --- CHANGE END ---
        
        async function loadDailyRecord(dateStr) {
            currentRecord = null;
            clearBoardUi();
            setStatus('讀取中...', 'loading');
            try {
                // Step 1: Fetch all patient data first
                await fetchAllActivePatients();
                
                // Step 2: Now that allPatients is populated, render the sidebar immediately
                renderInpatientList();

                // Step 3: Fetch the schedule for the day
                const dailyRecordRes = await fetch(`${API.daily_records}?date=${dateStr}`);
                if (!dailyRecordRes.ok) throw new Error('無法獲取本日排程');
                const records = await dailyRecordRes.json();

                if (records.length > 0) {
                    currentRecord = records[0];
                    renderDataToUI(currentRecord.schedule || {});
                    setStatus('資料已載入', 'saved');
                } else {
                    setStatus('本日無排班資料', 'saved');
                }
                
                updateShiftPatientCount();
            } catch (error) {
                console.error('讀取資料失敗:', error);
                setStatus('讀取失敗', 'error');
                // Ensure inpatient list is still rendered even on error
                renderInpatientList(); 
            }
        }

        function renderDataToUI(scheduleData) {
            // This function from V31.2 is correct and unchanged
            for (const slotKey in scheduleData) {
                const data = scheduleData[slotKey];
                const patient = allPatients.find(p => p.id === data.patientId);
                if (!patient) continue; 
                let shiftId;
                const parts = slotKey.split('-');
                const shiftIndex = parts.pop();
                const shiftName = Object.keys(shiftToIndexMap).find(key => shiftToIndexMap[key] === parseInt(shiftIndex));
                if (!shiftName) continue;
                const baseId = parts.join('-');
                if (baseId.startsWith('peripheral')) { shiftId = `${baseId}-${shiftName}`; } 
                else { shiftId = `bed-${baseId}-${shiftName}`; }
                const row = document.querySelector(`[data-shift-id="${shiftId}"]`);
                if (!row) continue;
                const patientCell = row.querySelector('.patient-name, .peripheral-patient-name');
                if (patientCell) patientCell.textContent = patient.name;
                if (baseId.startsWith('peripheral')) {
                    const bedNumberCell = row.querySelector('.peripheral-bed-number');
                    if (bedNumberCell && data.bedNumber) { bedNumberCell.textContent = data.bedNumber; }
                }
                const tagCell = row.querySelector('.patient-tag');
                if (tagCell) {
                    const diseaseAbbr = (patient.diseases || []).map(d => DISEASE_ABBR_MAP[d] || '').join('');
                    const savedTag = data.tag || '';
                    let userAddedPart = savedTag;
                    if(diseaseAbbr.length > 0 && savedTag.startsWith(diseaseAbbr)) {
                        userAddedPart = savedTag.substring(diseaseAbbr.length);
                    }
                    tagCell.innerHTML = ''; 
                    const diseaseSpan = document.createElement('span');
                    diseaseSpan.className = 'disease-tag-display';
                    diseaseSpan.textContent = diseaseAbbr;
                    tagCell.appendChild(diseaseSpan);
                    tagCell.appendChild(document.createTextNode(userAddedPart));
                }
                if (patientCell.textContent) { updatePatientCellStyle(patientCell, data.tag || ''); }
                if (row.classList.contains('split-shift')) { 
                    if(data.nurse_in) row.querySelector('.nurse-in').value = data.nurse_in; 
                    if(data.nurse_out) row.querySelector('.nurse-out').value = data.nurse_out; 
                } else { 
                    if(data.nurse) row.querySelector('.nurse-team-select').value = data.nurse; 
                }
            }
        }

        function collectDataFromUI() {
             // This function from V31.2 is correct and unchanged
            const schedule = {};
            document.querySelectorAll('.shift-row, .peripheral-shift-row').forEach(row => {
                const shiftId = row.dataset.shiftId;
                const patientName = (row.querySelector('.patient-name, .peripheral-patient-name') || {}).textContent || '';
                if (patientName.trim() !== '') {
                    const patient = allPatients.find(p => p.name === patientName.trim());
                    if(!patient) {
                        console.warn(`Patient "${patientName}" not found in master list. Skipping.`);
                        return;
                    }
                    let slotKey;
                    const parts = shiftId.split('-');
                    const shiftName = parts.pop();
                    const shiftIndex = shiftToIndexMap[shiftName];
                    const baseId = parts.join('-');
                    if (baseId.startsWith('bed-')) { slotKey = `${baseId.substring(4)}-${shiftIndex}`; } 
                    else if (baseId.startsWith('peripheral-')) { slotKey = `${baseId}-${shiftIndex}`; } 
                    else { return; }
                    const tag = row.querySelector('.patient-tag')?.textContent || '';
                    let slotData = { patientId: patient.id, tag };
                    if (row.classList.contains('split-shift')) {
                        const nurseIn = row.querySelector('.nurse-in').value;
                        const nurseOut = row.querySelector('.nurse-out').value || nurseIn;
                        if(nurseIn) slotData.nurse_in = nurseIn;
                        if(nurseOut) slotData.nurse_out = nurseOut;
                    } else {
                        const nurse = row.querySelector('.nurse-team-select').value;
                        if(nurse) slotData.nurse = nurse;
                    }
                    if (row.classList.contains('peripheral-shift-row')) {
                        slotData.bedNumber = row.querySelector('.peripheral-bed-number').textContent;
                    }
                    schedule[slotKey] = slotData;
                }
            });
            return schedule;
        }

        async function saveDataToCloud() {
            // This function from V31.2 is correct and unchanged
            clearAllHighlights();
            const validationResult = validateNoDuplicatePatients();
            if (!validationResult.isValid) { /* ... */ return; }
            const scheduleData = collectDataFromUI();
            if (Object.keys(scheduleData).length === 0) {
                if (currentRecord) { await deleteDailyRecord(); } 
                else { alert("沒有可儲存的資料。"); }
                return;
            }
            const dateStr = formatDate(currentDate);
            const dataToSave = { 
                date: dateStr, 
                schedule: scheduleData,
                names: currentRecord?.names || {} 
            };
            setStatus('儲存中...', 'loading');
            try {
                const method = currentRecord ? 'PUT' : 'POST';
                const url = currentRecord ? `${API.daily_records}/${currentRecord.id}` : API.daily_records;
                const response = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dataToSave) });
                if (!response.ok) throw new Error(`HTTP 儲存錯誤! 狀態: ${response.status}`);
                currentRecord = await response.json();
                setStatus(`資料已於 ${new Date().toLocaleTimeString()} 儲存成功`, 'saved');
            } catch (error) { 
                console.error('儲存至雲端失敗:', error); 
                setStatus('儲存失敗，請稍後再試', 'error'); 
            }
        }
        
        async function deleteDailyRecord() { /* ... unchanged ... */ }
        async function copySchedule() { /* ... unchanged ... */ }
        
        const search = () => { /* ... unchanged ... */ };
        
        function changeDate(days) {
            currentDate.setDate(currentDate.getDate() + days);
            updateDateDisplay();
            loadDailyRecord(formatDate(currentDate));
        }

        function isPatientScheduledToday(patientId) {
            if (!allPatients.length) return false;
            const patient = allPatients.find(p => p.id === patientId);
            if (!patient) return false;
            const patientName = patient.name;
            const patientCells = document.querySelectorAll('.patient-name, .peripheral-patient-name');
            for (const cell of patientCells) {
                if (cell.textContent.trim() === patientName) { return true; }
            }
            return false;
        }

        function renderInpatientList() {
            let inpatients = allPatients.filter(p => p.status === 'ipd' && !p.isDeleted);
            const regularFreqs = ['一三五', '二四六'];
            if (inpatientFilter === '135') { inpatients = inpatients.filter(p => p.frequency === '一三五');
            } else if (inpatientFilter === '246') { inpatients = inpatients.filter(p => p.frequency === '二四六');
            } else if (inpatientFilter === 'other') { inpatients = inpatients.filter(p => !regularFreqs.includes(p.frequency)); }
            
            inpatientList.innerHTML = '';
            if (inpatients.length === 0) {
                inpatientList.innerHTML = '<li>無符合條件的住院病人</li>';
            } else {
                inpatients.forEach(p => {
                    const li = document.createElement('li');
                    if (isPatientScheduledToday(p.id)) { li.classList.add('scheduled-inpatient'); }
                    li.innerHTML = `
                        <div class="patient-info-row">
                            <span class="name">${p.name}</span>
                            <span class="freq">${p.frequency || '未設定'}</span>
                        </div>
                        <div class="patient-info-row">
                            <span class="mrn">(${p.medicalRecordNumber || '無病歷號'})</span>
                        </div>
                    `;
                    inpatientList.appendChild(li);
                });
            }
        }
        
        function validateNoDuplicatePatients() { /* ... unchanged ... */ }
        function clearAllHighlights() { /* ... unchanged ... */ }
        function highlightDuplicatePatients(names) { /* ... unchanged ... */ }

        document.getElementById('prev-date-btn').addEventListener('click', () => changeDate(-1));
        document.getElementById('next-date-btn').addEventListener('click', () => changeDate(1));
        document.getElementById('today-btn').addEventListener('click', () => { currentDate = new Date(); updateDateDisplay(); loadDailyRecord(formatDate(currentDate)); });
        document.getElementById('save-btn').addEventListener('click', saveDataToCloud);
        document.getElementById('print-btn').addEventListener('click', printSchedule);
        document.getElementById('search-btn').addEventListener('click', search);
        
        document.getElementById('clear-all-btn').addEventListener('click', () => {
            if (currentRecord) {
                if (confirm("偵測到本日雲端有排程資料，您要一併刪除嗎？\n\n- 按 [確定] 將會刪除雲端資料並清空畫面。\n- 按 [取消] 將只會清空目前畫面（下次載入時會重新同步）。")) {
                    deleteDailyRecord().then(() => {
                        clearBoardUi();
                        renderInpatientList();
                    });
                } else {
                    clearBoardUi();
                    renderInpatientList();
                }
            } else {
                if (confirm('確定要清除畫面上的所有資料嗎？')) {
                    clearBoardUi();
                    renderInpatientList();
                }
            }
        });
        
        document.getElementById('copy-schedule-btn').addEventListener('click', copySchedule);
        
        document.addEventListener('input', (e) => {
            setStatus('內容已變更，尚未儲存', 'unsaved');
            const patientCell = e.target.closest('.shift-row, .peripheral-shift-row')?.querySelector('.patient-name, .peripheral-patient-name');
            if(patientCell) {
                const tagCell = e.target.closest('.shift-row, .peripheral-shift-row')?.querySelector('.patient-tag');
                if (e.target.classList.contains('patient-tag')) {
                    updatePatientCellStyle(patientCell, e.target.textContent);
                } else if (e.target.matches('.patient-name, .peripheral-patient-name')) {
                    updateShiftPatientCount();
                    updatePatientCellStyle(patientCell, tagCell ? tagCell.textContent : '');
                }
            }
        });

        filterGroup.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                filterGroup.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
                inpatientFilter = e.target.dataset.filter;
                renderInpatientList();
            }
        });

        generateLayout();
        updateDateDisplay();
        loadDailyRecord(formatDate(currentDate));
    });
    </script>
</body>
</html>
