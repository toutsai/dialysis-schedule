<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>門診週排班總表 (V1.5)</title>
    <style> /* CSS 與 V1.4 完全相同 */ </style>
</head>
<body>
    <!-- HTML 結構與 V1.4 完全相同 -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const API = {
            patients: 'https://684eb206f0c9c9848d28d637.mockapi.io/patients',
            weeklySchedule: 'https://684eb206f0c9c9848d28d637.mockapi.io/weekly_schedule'
        };
        const SHIFTS = ['早班', '午班', '晚班'];
        const WEEKDAYS = ['星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
        const FREQ_MAP = { '一三五': [0, 2, 4], '二四六': [1, 3, 5], '一四': [0, 3], '二五': [1, 4], '三六': [2, 5], '一五': [0, 4], '二六': [1, 5] };
        const bedLayout = [ 1,2,3,5,6,7,8,9,11,12,13,15,16,17,18,19,21,22,23,25,26,27,28,29, 31,32,33,35,36,37,38,39,51,52,53,55,56,57,58,59,61,62,63,64 ].sort((a, b) => a - b);
        const hepatitisBeds = [31, 32, 33, 35, 36];
        
        let allPatients = [];
        let weeklyScheduleData = {};
        let currentWeekStartDate = getStartOfWeek(new Date());
        let pendingChanges = { toAdd: {}, toDelete: {} };

        const weekDisplay = document.getElementById('week-display');
        const addScheduleDialog = document.getElementById('add-schedule-dialog');
        const patientSearchInput = document.getElementById('patient-search');
        const patientSelect = document.getElementById('patient-select');
        const patientFreqDisplay = document.getElementById('patient-freq-display');
        const statusIndicator = document.getElementById('status-indicator');

        function getStartOfWeek(date) { const d = new Date(date); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1); return new Date(new Date(d.setDate(diff)).setHours(0,0,0,0)); }
        const formatDate = (date) => { const d = new Date(date); return `${d.getMonth() + 1}月${d.getDate()}日`; };
        const generateDiseaseTags = (diseases) => { if (!diseases || diseases.length === 0) return ''; return diseases.map(d => `<span class="disease-tag">${d.slice(0,1)}</span>`).join(''); };
        
        function updateWeekDisplay() {
            const start = new Date(currentWeekStartDate);
            const end = new Date(start);
            end.setDate(start.getDate() + 5);
            weekDisplay.textContent = `${formatDate(start)} ~ ${formatDate(end)}`;
        }

        async function loadAllData() {
            pendingChanges = { toAdd: {}, toDelete: {} };
            updateStatusIndicator();
            try {
                const [patientsRes, scheduleRes] = await Promise.all([
                    fetch(API.patients),
                    fetch(`${API.weeklySchedule}?weekStart=${currentWeekStartDate.toISOString().split('T')[0]}`)
                ]);
                if (!patientsRes.ok || !scheduleRes.ok) throw new Error('Network error');
                allPatients = await patientsRes.json();
                const scheduleArray = await scheduleRes.json();
                weeklyScheduleData = scheduleArray.reduce((acc, item) => { acc[item.slotId] = item; return acc; }, {});
                
                renderWeeklyScheduleTable();
            } catch (error) {
                console.error("Failed to fetch data:", error);
                alert("讀取雲端資料失敗！");
            }
        };

        const renderWeeklyScheduleTable = () => {
            const head = document.getElementById('weekly-schedule-head');
            const body = document.getElementById('weekly-schedule-body');
            head.innerHTML = `<tr><th>床位</th><th>班次</th>${WEEKDAYS.map(day => `<th>${day}</th>`).join('')}</tr>`;
            let bodyHtml = '';
            bedLayout.forEach(bedNumber => {
                const isHepatitis = hepatitisBeds.includes(bedNumber);
                SHIFTS.forEach((shift, shiftIndex) => {
                    const rowClass = isHepatitis ? 'hepatitis-bed' : '';
                    bodyHtml += `<tr class="${rowClass}">`;
                    if (shiftIndex === 0) bodyHtml += `<td class="bed-label bed-label-bed" rowspan="3">${bedNumber}號床</td>`;
                    bodyHtml += `<td class="bed-label bed-label-shift">${shift}</td>`;
                    WEEKDAYS.forEach((day, dayIndex) => {
                        const slotId = `${bedNumber}-${shiftIndex}-${dayIndex}`;
                        bodyHtml += `<td data-slot-id-wrapper="${slotId}"><div class="schedule-slot" data-slot-id="${slotId}"></div></td>`;
                    });
                    bodyHtml += `</tr>`;
                });
            });
            body.innerHTML = bodyHtml;
            populateScheduleData();
            addSlotEventListeners();
            updateStatsToolbar();
        };

        const populateScheduleData = () => { /* ...與V1.3/V1.4相同... */ };
        function addSlotEventListeners() { /* ...與V1.3/V1.4相同... */ };
        const updateStatsToolbar = () => { /* ...與V1.3/V1.4相同... */ };
        const openAddScheduleDialog = (slotId) => { /* ...與V1.3/V1.4相同... */ };
        const updateStatusIndicator = () => { /* ...與V1.3/V1.4相同... */ };
        const handleAddSchedule = () => { /* ...與V1.3/V1.4相同... */ };
        const clearScheduleSlot = (scheduleId, slotId) => { /* ...與V1.3/V1.4相同... */ };
        const saveChangesToCloud = async () => { /* ...與V1.3/V1.4相同... */ };
        const copyToNextWeek = async () => { /* ...與V1.3/V1.4相同... */ };
        const changeWeek = (days) => { currentWeekStartDate.setDate(currentWeekStartDate.getDate() + days); updateWeekDisplay(); loadAllData(); };

        // ...其他事件綁定與初始化...
        document.getElementById('prev-week-btn').addEventListener('click', () => changeWeek(-7));
        document.getElementById('next-week-btn').addEventListener('click', () => changeWeek(7));
        document.getElementById('today-week-btn').addEventListener('click', () => { currentWeekStartDate = getStartOfWeek(new Date()); loadAllData(); });
        document.getElementById('copy-to-next-week-btn').addEventListener('click', copyToNextWeek);
        document.getElementById('save-changes-btn').addEventListener('click', saveChangesToCloud);
        document.getElementById('add-schedule-confirm-btn').addEventListener('click', handleAddSchedule);
        document.getElementById('add-schedule-cancel-btn').addEventListener('click', () => addScheduleDialog.close());

        updateWeekDisplay();
        loadAllData();
    });
    </script>
</body>
</html>
