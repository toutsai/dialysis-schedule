<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>洗腎室床位病人排程表 (V23.0 - 重複排班驗證版)</title>
    <style>
        /* CSS 與 V22.9 完全相同 */
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f4f7f6; padding: 20px; color: #333; }
        .controls-panel { max-width: 1800px; margin: 0 auto 20px; padding: 15px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
        .controls-panel button { padding: 8px 15px; font-size: 1em; border-radius: 5px; border: 1px solid #ccc; background-color: #e9e9e9; cursor: pointer; transition: background-color 0.2s; }
        #save-btn { background-color: #4CAF50; color: white; border-color: #4CAF50;}
        /* ... 其他 CSS ... */
        .bed.hepatitis .bed-header { background-color: #fffde7; color: #af8203; }
        .bed.hepatitis { border-color: #fffde7; }
        .patient-name.tag-chou, .peripheral-patient-name.tag-chou { background-color: #90caf9 !important; }
        .patient-name.hospitalized, .peripheral-patient-name.hospitalized { background-color: #ffcdd2 !important; }
        .patient-name.tag-huan, .peripheral-patient-name.tag-huan { background-color: #e3f2fd !important; }
        .patient-name.tag-liang, .peripheral-patient-name.tag-liang { background-color: #ffcc80 !important; }
        .patient-name.tag-b, .peripheral-patient-name.tag-b { background-color: #fffde7 !important; }
        @page { size: A4 landscape; margin: 0.5cm; }
        @media print {
            /* ... Print CSS 與 V22.8 完全相同 ... */
        }
    </style>
</head>
<body>
    <!-- HTML Body 結構無變更 -->
    <div class="date-navigator">
        <button id="prev-date-btn" class="date-nav-btn"><</button>
        <h1 id="current-date-display"></h1>
        <div class="shift-patient-count">
            <div>早班：<span id="early-shift-count">0</span></div>
            <div>午班：<span id="noon-shift-count">0</span></div>
            <div>晚班：<span id="late-shift-count">0</span></div>
        </div>
        <button id="next-date-btn" class="date-nav-btn">></button>
        <button id="today-btn">回到今日</button>
    </div>
    <div class="controls-panel">
        <button id="save-btn">儲存資料至雲端</button>
        <button id="print-btn">列印排程</button>
        <button id="clear-all-btn">清除本日畫面</button>
        <input type="date" id="copy-source-date">
        <button id="copy-schedule-btn">從他日複製排程</button>
        <div class="search-group">
            <input type="text" id="search-input" placeholder="搜尋...">
            <button id="search-btn">搜尋</button>
        </div>
        <button id="open-stats-btn">查看統計報表</button>
        <div class="shift-patient-count">
            <div>早班：<span id="early-shift-count">0</span></div>
            <div>午班：<span id="noon-shift-count">0</span></div>
            <div>晚班：<span id="late-shift-count">0</span></div>
        </div>
        <div id="status-indicator" class="status-indicator"></div>
    </div>
    <div class="dialysis-unit">
        <div class="left-wing" id="left-wing"></div>
        <div class="aisle">中 央 走 道</div>
        <div class="right-wing" id="right-wing"></div>
    </div>
    <div class="extra-sections">
        <div class="peripheral-section">
            <h2>外圍床位</h2>
            <div class="peripheral-bed-container" id="peripheral-bed-container"></div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const API_BASE_URL = 'https://684eb206f0c9c9848d28d637.mockapi.io/schedules';
        // ... 其他變數和佈局生成函數與 V22.9 相同 ...
        let currentDate = new Date();
        let currentRecordId = null;
        let currentNamesData = {};
        const statusIndicator = document.getElementById('status-indicator');
        const baseTeams = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', '外圍'];
        const earlyTeams = baseTeams.map(t => `早${t}`);
        const lateTeams = baseTeams.map(t => `晚${t}`);
        const allTeams = [...earlyTeams, ...lateTeams]; 
        const earlyOptionsHTML = earlyTeams.map(team => `<option value="${team}">${team}組</option>`).join('');
        const lateOptionsHTML = lateTeams.map(team => `<option value="${team}">${team}組</option>`).join('');
        const allOptionsHTML = allTeams.map(team => `<option value="${team}">${team}組</option>`).join('');
        const layoutData = { leftWingRows: [['空', 32, 31], [33, 35, 36], [39, 38, 37], [51, 52, 53], [57, 56, 55], [58, 59, 61], [64, 63, 62]], rightWingRows: [[29, 28, 27], [23, 25, 26], [22, 21, 19], [16, 17, 18], [15, 13, 12], [8, 9, 11], [7, 6, 5], [1, 2, 3]] };
        const aisleSideBeds = [1, 7, 8, 15, 16, 22, 23, 29, 31, 36, 37, 53, 55, 61, 62, 64];
        const hepatitisBeds = ['空', 31, 32, 33, 35, 36];
        const peripheralBedCount = 6;
        const leftWing = document.getElementById('left-wing');
        const rightWing = document.getElementById('right-wing');
        const peripheralContainer = document.getElementById('peripheral-bed-container');
        function generateWingLayout(container, rows, wingClass) { rows.forEach(rowBeds => { const rowDiv = document.createElement('div'); rowDiv.className = 'bed-row'; rowBeds.forEach(bedNumber => { rowDiv.appendChild(createBedElement(bedNumber, hepatitisBeds.includes(bedNumber), aisleSideBeds.includes(bedNumber), wingClass)); }); container.appendChild(rowDiv); }); }
        function createBedElement(bedNumber, isHepatitis, isAisleSide, wingClass) { if (bedNumber === null) { const p = document.createElement('div'); p.className = 'bed placeholder'; return p; } const bedDiv = document.createElement('div'); bedDiv.className = `bed ${wingClass}`; bedDiv.dataset.bedId = `bed-${bedNumber}`; if (isAisleSide) bedDiv.classList.add('aisle-side'); if (isHepatitis) bedDiv.classList.add('hepatitis'); if (bedNumber === '空') bedDiv.classList.add('unassigned'); let headerText = `床號 ${bedNumber}`; if (bedNumber === '空') headerText = '未排床'; else if (isHepatitis) headerText += ' (BC肝炎)'; const shiftRowsHTML = ['早', '午', '晚'].map(shift => { const shiftId = `bed-${bedNumber}-${shift}`; if (shift === '午') { const nurseInOptions = earlyOptionsHTML; const nurseOutOptions = allOptionsHTML; return `<div class="shift-row split-shift" data-shift-id="${shiftId}"><div class="shift-label">午</div><div class="nurse-split-column"><select class="nurse-team-select nurse-in" title=""><option value="">上針</option>${nurseInOptions}</select><select class="nurse-team-select nurse-out" title=""><option value="">收針</option>${nurseOutOptions}</select></div><div class="patient-name" contenteditable="true"></div><div class="patient-tag" contenteditable="true"></div></div>`; } else { const options = shift === '早' ? earlyOptionsHTML : lateOptionsHTML; return `<div class="shift-row" data-shift-id="${shiftId}"><div class="shift-label">${shift}</div><select class="nurse-team-select" title=""><option value="">-</option>${options}</select><div class="patient-name" contenteditable="true"></div><div class="patient-tag" contenteditable="true"></div></div>`; } }).join(''); bedDiv.innerHTML = `<div class="bed-header">${headerText}</div>${bedNumber !== '空' ? shiftRowsHTML : ''}`; return bedDiv; }
        function createPeripheralBedElement(index) { const bedDiv = document.createElement('div'); bedDiv.className = 'peripheral-bed'; const shiftRowsHTML = ['早', '午', '晚'].map(shift => { let options; switch (shift) { case '早': options = earlyOptionsHTML; break; case '晚': options = lateOptionsHTML; break; case '午': options = allOptionsHTML; break; } return `<div class="peripheral-shift-row" data-shift-id="peripheral-${index}-${shift}"><div class="shift-label">${shift}</div><select class="nurse-team-select" title=""><option value="">-</option>${options}</select><div class="peripheral-bed-number" contenteditable="true"></div><div class="peripheral-patient-name" contenteditable="true"></div><div class="patient-tag" contenteditable="true"></div></div>`; }).join(''); bedDiv.innerHTML = `<div class="peripheral-header">外圍床位 ${index}</div>${shiftRowsHTML}`; return bedDiv; }
        const formatDate = (date) => date.toISOString().split('T')[0];
        const updateDateDisplay = () => { const dateStr = formatDate(currentDate); document.getElementById('current-date-display').textContent = dateStr; document.getElementById('copy-source-date').value = dateStr; };
        const setStatus = (message, type) => { statusIndicator.textContent = message; statusIndicator.className = `status-indicator ${type}`; };
        function clearBoard() { document.querySelectorAll('.nurse-team-select').forEach(s => { s.value = ''; s.title=''; }); document.querySelectorAll('div[contenteditable="true"]').forEach(d => d.textContent = ''); document.querySelectorAll('.hospitalized, .tag-chou, .tag-liang, .tag-b, .tag-huan').forEach(el => el.classList.remove('hospitalized', 'tag-chou', 'tag-liang', 'tag-b', 'tag-huan')); currentRecordId = null; currentNamesData = {}; updateShiftPatientCount(); setStatus('新排程，尚未儲存', 'unsaved'); }
        const updateShiftPatientCount = () => { let earlyCount = 0; let noonCount = 0; let lateCount = 0; document.querySelectorAll('.patient-name, .peripheral-patient-name').forEach(patientField => { if (patientField.textContent.trim() !== '') { const parentRow = patientField.closest('.shift-row, .peripheral-shift-row'); if (parentRow) { const shiftId = parentRow.dataset.shiftId; if (shiftId.includes('-早')) earlyCount++; else if (shiftId.includes('-午')) noonCount++; else if (shiftId.includes('-晚')) lateCount++; } } }); document.querySelectorAll('#early-shift-count').forEach(el => el.textContent = earlyCount); document.querySelectorAll('#noon-shift-count').forEach(el => el.textContent = noonCount); document.querySelectorAll('#late-shift-count').forEach(el => el.textContent = lateCount); };
        const checkTagStatus = (tagElement) => { const parentRow = tagElement.closest('.shift-row, .peripheral-shift-row'); if (!parentRow) return; const patientCell = parentRow.querySelector('.patient-name, .peripheral-patient-name'); if (patientCell) { const tagText = tagElement.textContent.toUpperCase(); patientCell.classList.remove('tag-chou', 'hospitalized', 'tag-huan', 'tag-liang', 'tag-b'); if (tagText.includes('抽')) { patientCell.classList.add('tag-chou'); } else if (tagText.includes('住')) { patientCell.classList.add('hospitalized'); } else if (tagText.includes('換')) { patientCell.classList.add('tag-huan'); } else if (tagText.includes('兩')) { patientCell.classList.add('tag-liang'); } else if (tagText.includes('B')) { patientCell.classList.add('tag-b'); } } };
        const search = () => { /* ... */ };
        function collectDataFromUI() { /* ... */ }
        async function loadDataFromCloud(dateStr) { /* ... */ }
        function renderDataToUI(scheduleData) { /* ... */ }
        async function copySchedule() { /* ... */ }
        function openStatsPage() { /* ... */ }
        const printSchedule = () => window.print();
        function changeDate(days) { currentDate.setDate(currentDate.getDate() + days); updateDateDisplay(); loadDataFromCloud(formatDate(currentDate)); }

        // --- CHANGE START: 新增重複驗證函式，並修改儲存函式 ---
        function validateNoDuplicatePatients() {
            const patientNames = new Set();
            const patientElements = document.querySelectorAll('.patient-name, .peripheral-patient-name');
            
            for (const el of patientElements) {
                const name = el.textContent.trim();
                if (name === '') {
                    continue; // 跳過空欄位
                }
                if (patientNames.has(name)) {
                    // 找到重複，回傳重複的姓名以供提示
                    return { duplicate: true, name: name };
                }
                patientNames.add(name);
            }
            // 沒有重複
            return { duplicate: false };
        }

        async function saveDataToCloud() {
            // 步驟1: 執行驗證
            const validationResult = validateNoDuplicatePatients();
            if (validationResult.duplicate) {
                alert(`儲存失敗：病人 "${validationResult.name}" 在今日排程中重複出現！`);
                setStatus('儲存失敗，發現重複排班', 'error');
                return; // 中止儲存
            }
            
            // 步驟2: (驗證通過) 執行原有儲存邏輯
            const scheduleData = collectDataFromUI();
            const dateStr = formatDate(currentDate);
            const dataToSave = { date: dateStr, schedule: scheduleData, names: currentNamesData };
            
            setStatus('儲存中...', 'loading');
            try {
                const method = currentRecordId ? 'PUT' : 'POST';
                const url = currentRecordId ? `${API_BASE_URL}/${currentRecordId}` : API_BASE_URL;
                const response = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dataToSave) });
                if (!response.ok) throw new Error(`HTTP 錯誤! 狀態: ${response.status}`);
                const savedRecord = await response.json();
                currentRecordId = savedRecord.id;
                setStatus(`資料已於 ${new Date().toLocaleTimeString()} 儲存成功`, 'saved');
            } catch (error) {
                console.error('儲存至雲端失敗:', error);
                setStatus('儲存失敗，請稍後再試', 'error');
            }
        }
        // --- CHANGE END ---

        // --- 事件綁定 ---
        document.getElementById('prev-date-btn').addEventListener('click', () => changeDate(-1));
        document.getElementById('next-date-btn').addEventListener('click', () => changeDate(1));
        document.getElementById('today-btn').addEventListener('click', () => { currentDate = new Date(); updateDateDisplay(); loadDataFromCloud(formatDate(currentDate)); });
        document.getElementById('save-btn').addEventListener('click', saveDataToCloud); // 按鈕仍綁定 saveDataToCloud，但函式內部邏輯已更新
        document.getElementById('print-btn').addEventListener('click', printSchedule);
        document.getElementById('search-btn').addEventListener('click', search);
        document.getElementById('open-stats-btn').addEventListener('click', openStatsPage);
        document.getElementById('clear-all-btn').addEventListener('click', () => { if(confirm('確定要清除畫面上的所有資料嗎？(此操作不會影響雲端儲存的資料)')) { clearBoard(); } });
        document.getElementById('copy-schedule-btn').addEventListener('click', copySchedule);
        document.addEventListener('input', (e) => { setStatus('內容已變更，尚未儲存', 'unsaved'); if (e.target.classList.contains('patient-tag')) { checkTagStatus(e.target); } });

        // --- 初始化 ---
        generateWingLayout(leftWing, layoutData.leftWingRows, 'left-wing-bed');
        generateWingLayout(rightWing, layoutData.rightWingRows, 'right-wing-bed');
        const nursingStationRow = document.createElement('div'); nursingStationRow.className = 'bed-row'; nursingStationRow.innerHTML = '<div class="nursing-station">護理站</div>'; leftWing.appendChild(nursingStationRow);
        for (let i = 1; i <= peripheralBedCount; i++) { peripheralContainer.appendChild(createPeripheralBedElement(i)); }
        updateDateDisplay();
        loadDataFromCloud(formatDate(currentDate));

        // --- 為了程式碼完整性，複製貼上其他未變動的函式 ---
        collectDataFromUI = () => { const scheduleData = {}; document.querySelectorAll('.shift-row, .peripheral-shift-row').forEach(row => { const id = row.dataset.shiftId; let data = {}; const tag = row.querySelector('.patient-tag')?.textContent || ''; if (row.classList.contains('split-shift')) { const nurseIn = row.querySelector('.nurse-in').value; let nurseOut = row.querySelector('.nurse-out').value; if (nurseIn && !nurseOut) { nurseOut = nurseIn; } data = { nurse_in: nurseIn, nurse_out: nurseOut, patient: row.querySelector('.patient-name').textContent, tag }; } else if (row.classList.contains('shift-row')) { data = { nurse: row.querySelector('.nurse-team-select').value, patient: row.querySelector('.patient-name').textContent, tag }; } else { data = { nurse: row.querySelector('.nurse-team-select').value, bedNumber: row.querySelector('.peripheral-bed-number').textContent, patient: row.querySelector('.peripheral-patient-name').textContent, tag }; } if (Object.values(data).some(val => val && val.trim() !== '')) { scheduleData[id] = data; } }); return scheduleData; }
        loadDataFromCloud = async (dateStr) => { clearBoard(); setStatus('讀取中...', 'loading'); try { const response = await fetch(`${API_BASE_URL}?date=${dateStr}`); if (!response.ok) throw new Error(`HTTP 錯誤! 狀態: ${response.status}`); const data = await response.json(); if (data.length > 0) { const record = data[0]; currentRecordId = record.id; currentNamesData = record.names || {}; renderDataToUI(record.schedule); setStatus('資料已從雲端載入', 'saved'); } else { setStatus('本日無雲端資料，可建立新排程', 'unsaved'); } } catch (error) { console.error('從雲端讀取資料失敗:', error); setStatus('讀取失敗，請檢查網路連線', 'error'); } }
        renderDataToUI = (scheduleData) => { Object.keys(scheduleData).forEach(id => { const row = document.querySelector(`[data-shift-id="${id}"]`); if (!row) return; const data = scheduleData[id]; const tagEl = row.querySelector('.patient-tag'); if(tagEl) tagEl.textContent = data.tag || ''; if (row.classList.contains('split-shift')) { row.querySelector('.nurse-in').value = data.nurse_in || ''; row.querySelector('.nurse-out').value = data.nurse_out || ''; row.querySelector('.patient-name').textContent = data.patient || ''; } else if (row.classList.contains('shift-row')) { row.querySelector('.nurse-team-select').value = data.nurse || ''; row.querySelector('.patient-name').textContent = data.patient || ''; } else if (row.classList.contains('peripheral-shift-row')) { row.querySelector('.nurse-team-select').value = data.nurse || ''; row.querySelector('.peripheral-bed-number').textContent = data.bedNumber || ''; row.querySelector('.peripheral-patient-name').textContent = data.patient || ''; } }); document.querySelectorAll('.patient-tag').forEach(checkTagStatus); updateShiftPatientCount(); }
        copySchedule = async () => { const sourceDateStr = document.getElementById('copy-source-date').value; if (!sourceDateStr) { alert("請選擇一個來源日期！"); return; } if (sourceDateStr === formatDate(currentDate)) { alert("來源日期與目前日期相同，無需複製。"); return; } if (!confirm(`確定要將 ${sourceDateStr} 的排程複製到 ${formatDate(currentDate)} 嗎？\n這會覆蓋當前畫面的所有內容！`)) return; setStatus(`從 ${sourceDateStr} 複製中...`, 'loading'); try { const response = await fetch(`${API_BASE_URL}?date=${sourceDateStr}`); if (!response.ok) throw new Error(`找不到來源日期的資料`); const data = await response.json(); if (data.length > 0) { const sourceData = data[0]; clearBoard(); currentNamesData = sourceData.names || {}; renderDataToUI(sourceData.schedule); setStatus('複製成功，請記得儲存', 'unsaved'); } else { alert(`在雲端找不到 ${sourceDateStr} 的排程資料。`); setStatus('複製失敗', 'error'); } } catch (error) { alert(`複製失敗: ${error.message}`); setStatus('複製失敗', 'error'); } }
        openStatsPage = () => { const dateStr = formatDate(currentDate); window.open(`stats.html?date=${dateStr}`, '_blank'); }
        search = () => { const searchTerm = document.getElementById('search-input').value.trim().toUpperCase(); document.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight')); if (!searchTerm) return; document.querySelectorAll('.shift-row, .peripheral-shift-row').forEach(row => { let textContent = ''; row.querySelectorAll('select, div[contenteditable="true"]').forEach(el => { textContent += (el.tagName === 'SELECT' ? (el.value ? el.options[el.selectedIndex].text : '') : el.textContent) + ' '; }); if (textContent.toUpperCase().includes(searchTerm)) { row.classList.add('highlight'); } }); };
    });
    </script>
</body>
</html>
