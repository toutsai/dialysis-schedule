<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>透析病人管理系統 (V2.2 - 多源儲存與容量管理版)</title>
    <style>
        /* CSS inalterado */
        :root { --green-bg: #e8f5e9; --green-text: #2e7d32; --blue-bg: #e3f2fd;  --blue-text: #1565c0; --orange-bg: #fff3e0; --orange-text: #ef6c00; --grey-bg: #f5f5f5; --grey-text: #616161; --red-text: #c62828; }
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background-color: #f9f9f9; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab-button { padding: 10px 20px; border: none; background: none; font-size: 1.2em; cursor: pointer; position: relative; color: #666; }
        .tab-button.active { color: #005a9c; font-weight: bold; }
        .tab-button.active::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 2px; background-color: #005a9c; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 15px; }
        .toolbar button { padding: 8px 15px; font-size: 1em; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .toolbar button:hover { background-color: #0056b3; }
        .stats-area { display: flex; gap: 20px; font-size: 0.9em; }
        .patient-table { width: 100%; border-collapse: collapse; table-layout: auto; }
        .patient-table th, .patient-table td { border: 1px solid #ddd; padding: 8px; text-align: left; white-space: nowrap; }
        .patient-table td:nth-child(1), .patient-table#ipd-table-body td:nth-child(8), .patient-table#opd-table-body td:nth-child(7) { white-space: normal; }
        .patient-table th { background-color: #f2f2f2; cursor: pointer; user-select: none; position: sticky; top: 0; }
        .patient-table th:hover { background-color: #e8e8e8; }
        .patient-table th .sort-indicator { display: inline-block; margin-left: 5px; color: #999; }
        .patient-table tr.status-opd { background-color: var(--green-bg); }
        .patient-table tr.status-ipd { background-color: var(--blue-bg); }
        .patient-table tr.status-biweekly { background-color: var(--orange-bg); }
        .patient-table tr.status-deleted { background-color: var(--grey-bg); color: var(--grey-text); }
        .disease-tag { display: inline-block; margin-left: 8px; padding: 2px 6px; font-size: 0.8em; font-weight: bold; color: var(--red-text); border: 1px solid var(--red-text); border-radius: 4px; }
        .action-buttons button { margin-right: 5px; padding: 4px 8px; font-size: 0.9em; border-radius: 3px; border: 1px solid #ccc; cursor: pointer; }
        .table-wrapper { max-height: 60vh; overflow-y: auto; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; padding: 20px; border: 1px solid #888; width: 90%; max-width: 700px; border-radius: 8px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; }
        .close-button { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .form-field { display: flex; flex-direction: column; }
        .form-field label { margin-bottom: 5px; font-weight: bold; }
        .form-field input, .form-field select, .form-field textarea { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
        .form-field-full { grid-column: 1 / -1; }
        .form-group { border: 1px solid #e0e0e0; padding: 15px; border-radius: 5px; margin-top: 10px; }
        .form-group legend { padding: 0 10px; font-weight: bold; color: #333; }
        .checkbox-container { display: flex; flex-wrap: wrap; gap: 20px; }
        .checkbox-group { display: flex; align-items: center; gap: 5px; }
        .checkbox-group input[type="checkbox"] { width: auto; height: 1.2em; width: 1.2em; }
        .checkbox-group label { font-weight: normal; margin-bottom: 0; }
        .modal-footer { margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; text-align: right; }
        #delete-reason-dialog { border: 1px solid #ccc; border-radius: 8px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        #delete-reason-dialog::backdrop { background-color: rgba(0,0,0,0.5); }
        #delete-reason-dialog h3 { margin-top: 0; }
        #delete-reason-dialog .button-group { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        #delete-reason-dialog button { width: 100%; padding: 10px; font-size: 1em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>透析病人管理系統</h1>
        <!-- --- CHANGE START: Add a button for exporting data --- -->
        <div class="toolbar" style="justify-content: flex-end;">
            <button id="export-all-patients-btn" style="background-color: #607d8b;">匯出所有病人備份</button>
        </div>
        <!-- --- CHANGE END --- -->
        <div class="tabs">
            <button class="tab-button active" data-tab="ipd">住院病人</button>
            <button class="tab-button" data-tab="opd">門診常規</button>
            <button class="tab-button" data-tab="deleted">已刪除病人</button>
        </div>
        <div id="ipd" class="tab-content active"><div class="toolbar"><button id="add-ipd-btn">新增住院病人</button><div class="stats-area" id="ipd-stats"></div></div><div class="table-wrapper"><table class="patient-table"><thead id="ipd-table-head"></thead><tbody id="ipd-table-body"></tbody></table></div></div>
        <div id="opd" class="tab-content"><div class="toolbar"><button id="add-opd-btn">新增門診病人</button><div class="stats-area" id="opd-stats"></div></div><div class="table-wrapper"><table class="patient-table"><thead id="opd-table-head"></thead><tbody id="opd-table-body"></tbody></table></div></div>
        <div id="deleted" class="tab-content"><div class="toolbar"><div>已刪除病人紀錄</div><div class="stats-area" id="deleted-stats"></div></div><div class="table-wrapper"><table class="patient-table"><thead id="deleted-table-head"></thead><tbody id="deleted-table-body"></tbody></table></div></div>
    </div>
    <div id="patient-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="modal-title">病人資料</h2><span class="close-button">×</span></div><div id="modal-form-content"></div></div></div>
    <dialog id="delete-reason-dialog"><h3>請選擇刪除原因</h3><div id="delete-reason-options" class="button-group"></div><div class="button-group"><button id="delete-cancel-btn" value="cancel">取消</button></div></dialog>
    <template id="ipd-form-template"><!-- ... no changes ... --></template>
    <template id="opd-form-template"><!-- ... no changes ... --></template>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CHANGE START: Define all API endpoints and capacity management variables ---
        const API_BASE_URL = 'https://6852ef850594059b23cfaa4f.mockapi.io';
        const API_ENDPOINTS = {
            ipd: [`${API_BASE_URL}/patients_ipd`],
            opd: [
                `${API_BASE_URL}/patients_opd_1`,
                `${API_BASE_URL}/patients_opd_2`,
                `${API_BASE_URL}/patients_opd_3`
            ],
            deleted: [
                `${API_BASE_URL}/patients_deleted_1`,
                `${API_BASE_URL}/patients_deleted_2`,
                `${API_BASE_URL}/patients_deleted_3`
            ]
        };
        const MOCKAPI_SOURCE_LIMIT = 100; // MockAPI free tier limit per resource
        
        let opdNextWriteIndex = 0;
        let deletedNextWriteIndex = 0;
        // --- CHANGE END ---
        
        const PHYSICIANS = ['廖丁瑩', '蔡宜潔', '蘇哲弘', '蔡亨政'];
        const FREQUENCIES = ['一三五', '二四六', '一四', '二五', '三六', '一五', '二六', '每周一次', '臨時'];
        const MODES = ['HD', 'SLED', 'CVVHDF', 'PP', 'DFPP'];
        const VASC_ACCESSES = ['Double lumen', 'PERM', '左手AVF', '右手AVF', '左手AVG', '右手AVG'];
        const DISEASES = ['HIV', 'RPR', 'HBV', 'HCV', '隔離'];
        const DELETE_REASONS = ['出院', '死亡', '轉外院透析', '轉PD或其他', '作廢'];
        
        let allPatients = [];
        let currentSort = { column: 'createdAt', order: 'desc' };
        
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const modal = document.getElementById('patient-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalFormContent = document.getElementById('modal-form-content');
        const deleteDialog = document.getElementById('delete-reason-dialog');
        
        const formatDate = (isoString) => isoString ? new Date(isoString).toLocaleDateString() : '';

        // --- CHANGE START: Major rewrite of data fetching logic ---
        async function fetchAllPatients() {
            const allEndpoints = [].concat(...Object.values(API_ENDPOINTS));
            const fetchPromises = allEndpoints.map(url => 
                fetch(url).then(res => {
                    if (!res.ok) throw new Error(`Failed to fetch from ${url}`);
                    return res.json();
                }).then(data => data.map(p => ({ ...p, sourceUrl: url }))) // Tag each patient with its source
            );

            try {
                const results = await Promise.all(fetchPromises);
                allPatients = [].concat(...results);
                
                // Find the next available slot for writing OPD and DELETED patients
                await findNextWriteIndex('opd', API_ENDPOINTS.opd.length);
                await findNextWriteIndex('deleted', API_ENDPOINTS.deleted.length);

                renderAllTables();
            } catch (error) {
                console.error("Failed to fetch patients:", error);
                alert("讀取病人資料失敗，請檢查網路連線或重新整理。");
            }
        }

        async function findNextWriteIndex(type, totalSources) {
            const counts = await Promise.all(API_ENDPOINTS[type].map(url =>
                fetch(url).then(res => res.headers.get('x-total-count') || res.json().then(d => d.length))
            ));
            
            for (let i = 0; i < totalSources; i++) {
                if (parseInt(counts[i], 10) < MOCKAPI_SOURCE_LIMIT) {
                    if (type === 'opd') opdNextWriteIndex = i;
                    if (type === 'deleted') deletedNextWriteIndex = i;
                    return;
                }
            }
            
            // If all are full
            if (type === 'opd') opdNextWriteIndex = -1; // -1 signifies all sources are full
            if (type === 'deleted') deletedNextWriteIndex = -1;
        }
        // --- CHANGE END ---

        function renderAllTables() { /* ... no changes ... */ }
        function renderTable(type) { /* ... no changes, existing logic works ... */ }
        function handleSort(key) { /* ... no changes ... */ }
        
        // --- CHANGE START: Update stats to show source usage ---
        const updateStats = () => {
            const ipdPatients = allPatients.filter(p => p.status === 'ipd' && !p.isDeleted);
            const opdPatients = allPatients.filter(p => p.status === 'opd' && !p.isDeleted);
            const deletedPatients = allPatients.filter(p => p.status === 'deleted');

            document.getElementById('ipd-stats').textContent = `總人數: ${ipdPatients.length}`;
            document.getElementById('opd-stats').textContent = `總人數: ${opdPatients.length}`;
            document.getElementById('deleted-stats').textContent = `總人數: ${deletedPatients.length}`;
            
            // Check capacity
            if (opdNextWriteIndex === -1) {
                document.getElementById('opd-stats').innerHTML += ` <span style="color:red; font-weight:bold;">(儲存空間已滿!)</span>`;
            }
            if (deletedNextWriteIndex === -1) {
                document.getElementById('deleted-stats').innerHTML += ` <span style="color:red; font-weight:bold;">(儲存空間已滿!)</span>`;
            }
        };
        // --- CHANGE END ---

        const getRowClass = (p) => { /* ... no changes ... */ };
        const generateDiseaseTags = (d) => { /* ... no changes ... */ };
        const sortPatients = (p) => { /* ... no changes ... */ };
        const openModal = (type, patient = null) => { /* ... no changes ... */ };
        const closeModal = () => { /* ... no changes ... */ };
        
        // --- CHANGE START: Major rewrite of form submission logic ---
        const handleFormSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const id = form.querySelector('#patient-id').value;
            const type = form.querySelector('#patient-type').value;

            // Handle capacity check for new OPD patients
            if (!id && type === 'opd' && opdNextWriteIndex === -1) {
                if(confirm("門診病人儲存空間已滿！\n\n- 按[確定]將會自動備份並清空最舊的門診病人資料，然後儲存這位新病人。\n- 按[取消]將取消此次儲存操作。")) {
                    await exportAndClearOldestSource('opd');
                } else {
                    return; // Cancel saving
                }
            }

            const selectedDiseases = Array.from(form.querySelectorAll('input[name="disease"]:checked')).map(cb => cb.value);
            let patientData = { 
                name: form.querySelector('#name').value, 
                medicalRecordNumber: form.querySelector('#medical-record-number').value, 
                physician: form.querySelector('#physician').value, 
                frequency: form.querySelector('#frequency').value, 
                mode: form.querySelector('#mode').value, 
                remarks: form.querySelector('#remarks').value, 
                diseases: selectedDiseases, 
                status: type, 
                isDeleted: false 
            };
            if (type === 'ipd') { patientData.isFirstDialysis = form.querySelector('#is-first-dialysis').checked; patientData.isDiscontinued = form.querySelector('#is-discontinued').checked; } 
            else { patientData.firstDialysisDate = form.querySelector('#first-dialysis-date').value; patientData.accessCreationDate = form.querySelector('#access-creation-date').value; patientData.vascAccess = form.querySelector('#vasc-access').value; }

            let url;
            let method;

            if (id) { // This is an existing patient (UPDATE)
                const existingPatient = allPatients.find(p => p.id === id);
                if (!existingPatient) { alert('找不到病人資料，無法更新。'); return; }
                url = `${existingPatient.sourceUrl}/${id}`;
                method = 'PUT';
            } else { // This is a new patient (CREATE)
                method = 'POST';
                if (type === 'ipd') url = API_ENDPOINTS.ipd[0];
                if (type === 'opd') url = API_ENDPOINTS.opd[opdNextWriteIndex];
                patientData.createdAt = new Date().toISOString();
            }

            try {
                const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(patientData) });
                if (!response.ok) throw new Error('Save error');
                await fetchAllPatients(); // Refetch everything to get the latest state
                closeModal();
            } catch (error) { console.error("Save failed:", error); alert("儲存失敗！"); }
        };
        // --- CHANGE END ---

        // --- CHANGE START: Rewrite of update/transfer/delete/restore logic ---
        // Generic function to move a patient record between sources
        async function movePatient(patient, newStatus) {
            let targetUrl;
            
            // Determine target URL and handle capacity
            if (newStatus === 'deleted') {
                if (deletedNextWriteIndex === -1) {
                    if(!confirm("刪除病人儲存空間已滿！\n\n- 按[確定]將會自動備份並清空最舊的已刪除病人資料，然後完成此操作。\n- 按[取消]將取消。")) return;
                    await exportAndClearOldestSource('deleted');
                }
                targetUrl = API_ENDPOINTS.deleted[deletedNextWriteIndex];
            } else if (newStatus === 'opd') {
                if (opdNextWriteIndex === -1) {
                    if(!confirm("門診病人儲存空間已滿！\n\n- 按[確定]將會自動備份並清空最舊的門診病人資料，然後完成此操作。\n- 按[取消]將取消。")) return;
                    await exportAndClearOldestSource('opd');
                }
                targetUrl = API_ENDPOINTS.opd[opdNextWriteIndex];
            } else if (newStatus === 'ipd') {
                targetUrl = API_ENDPOINTS.ipd[0];
            } else {
                console.error("Invalid new status:", newStatus); return;
            }
            
            try {
                // Step 1: Create the patient in the new location
                const createResponse = await fetch(targetUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...patient, id: undefined, sourceUrl: undefined }) // Remove old id and sourceUrl
                });
                if (!createResponse.ok) throw new Error(`Failed to create patient in new location ${targetUrl}`);

                // Step 2: Delete the patient from the old location
                const deleteResponse = await fetch(`${patient.sourceUrl}/${patient.id}`, { method: 'DELETE' });
                if (!deleteResponse.ok) console.warn(`Failed to delete patient from old location ${patient.sourceUrl}/${patient.id}, manual cleanup may be needed.`);

            } catch (error) {
                console.error("Move patient failed:", error);
                alert("移動病人資料失敗！");
            }
        }
        
        const transferToOpd = async (id) => { 
            if (!confirm('確定要將此病人轉為門診常規嗎？')) return;
            const patient = allPatients.find(p => p.id === id);
            if (!patient) return;
            
            const updatedPatient = { ...patient, status: 'opd' };
            await movePatient(updatedPatient, 'opd');
            await fetchAllPatients();
        };

        const archivePatient = async (id, reason) => {
            const patient = allPatients.find(p => p.id === id);
            if (!patient) return;
            
            const updatedPatient = { ...patient, status: 'deleted', isDeleted: true, originalStatus: patient.status, deleteReason: reason, deletedAt: new Date().toISOString() };
            await movePatient(updatedPatient, 'deleted');
            await fetchAllPatients();
        };

        const restorePatient = async (id) => {
            const patient = allPatients.find(p => p.id === id);
            if (!patient || !confirm(`確定要將病人「${patient.name}」復原到「${patient.originalStatus === 'ipd' ? '住院' : '門診'}」列表嗎？`)) return;

            const targetStatus = patient.originalStatus || 'opd';
            const updatedPatient = { ...patient, status: targetStatus, isDeleted: false, deleteReason: null, deletedAt: null };
            await movePatient(updatedPatient, targetStatus);
            await fetchAllPatients();
        };
        // --- CHANGE END ---

        const deletePatient = (id) => { /* ... no changes, but its call to archivePatient is now async ... */ };
        
        // --- CHANGE START: New functions for capacity management ---
        function exportAllPatients() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allPatients, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `all_patients_backup_${new Date().toISOString().split('T')[0]}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            alert('所有病人資料已匯出為 JSON 檔案。');
        }

        async function exportAndClearOldestSource(type) {
            const sourceUrlToClear = API_ENDPOINTS[type][0];
            try {
                // 1. Fetch data from the oldest source
                const response = await fetch(sourceUrlToClear);
                const dataToBackup = await response.json();
                
                // 2. Export it
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dataToBackup, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `${type}_source_1_backup_${new Date().toISOString().split('T')[0]}.json`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                
                // 3. Clear the source by deleting each item
                alert(`即將清空最舊的「${type === 'opd' ? '門診' : '已刪除'}」病人資料庫以釋放空間。\n相關備份檔已自動下載。`);
                const deletePromises = dataToBackup.map(p => fetch(`${sourceUrlToClear}/${p.id}`, { method: 'DELETE' }));
                await Promise.all(deletePromises);
                
                // 4. Update the write index
                if(type === 'opd') opdNextWriteIndex = 0;
                if(type === 'deleted') deletedNextWriteIndex = 0;

            } catch (error) {
                console.error(`Failed to export and clear source ${sourceUrlToClear}`, error);
                alert('自動備份與清空操作失敗，請手動處理。');
            }
        }
        // --- CHANGE END ---
        
        document.querySelector('.container').addEventListener('click', (e) => {
            const target = e.target;
            const action = target.dataset.action;
            const id = target.dataset.id;
            
            if (action && id) {
                // existing logic works, but now calls async functions
                switch(action) { /* ... */ }
            } else if (target.id === 'add-ipd-btn') {
                openModal('ipd');
            } else if (target.id === 'add-opd-btn') {
                openModal('opd');
            } else if (target.id === 'export-all-patients-btn') { // New listener
                exportAllPatients();
            }
        });

        // Other event listeners (tabs, modal close) are unchanged.
        
        fetchAllPatients();
    });
    </script>
</body>
</html>
