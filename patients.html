<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>透析病人管理系統 (V1.7 - 增量更新修正版)</title>
    <style> /* CSS 與 V1.2/V1.6 完全相同 */ </style>
</head>
<body>
    <!-- HTML 結構與 V1.2/V1.6 完全相同 -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_BASE_URL = 'https://684eb206f0c9c9848d28d637.mockapi.io/patients';
        const PHYSICIANS = ['廖丁瑩', '蔡宜潔', '蘇哲弘', '蔡亨政'];
        const FREQUENCIES = ['一三五', '二四六', '一四', '二五', '三六', '一五', '二六', '每周一次', '臨時'];
        const MODES = ['HD', 'SLED', 'CVVHDF', 'PP', 'DFPP'];
        const VASC_ACCESSES = ['Double lumen', 'PERM', '左手AVF', '右手AVF', '左手AVG', '右手AVG'];
        const DISEASES = ['HIV', 'RPR', 'HBV', 'HCV', '隔離'];
        const DELETE_REASONS = ['出院', '死亡', '轉外院透析', '轉PD或其他'];
        
        let allPatients = [];
        let currentSort = { column: 'createdAt', order: 'desc' };
        
        // --- 所有 DOM 元素獲取 (與V1.2相同) ---

        // --- CHANGE START: 全新的增量更新儲存邏輯 ---
        const handleFormSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const id = form.querySelector('#patient-id').value;
            const type = form.querySelector('#patient-type').value;
            const selectedDiseases = Array.from(form.querySelectorAll('input[name="disease"]:checked')).map(cb => cb.value);

            let patientData = {
                name: form.querySelector('#name').value,
                medicalRecordNumber: form.querySelector('#medical-record-number').value,
                physician: form.querySelector('#physician').value,
                frequency: form.querySelector('#frequency').value,
                mode: form.querySelector('#mode').value,
                remarks: form.querySelector('#remarks').value,
                diseases: selectedDiseases,
                status: type,
                isDeleted: false
            };

            if (type === 'ipd') {
                patientData.isFirstDialysis = form.querySelector('#is-first-dialysis').checked;
                patientData.isDiscontinued = form.querySelector('#is-discontinued').checked;
            } else {
                patientData.firstDialysisDate = form.querySelector('#first-dialysis-date').value;
                patientData.accessCreationDate = form.querySelector('#access-creation-date').value;
                patientData.vascAccess = form.querySelector('#vasc-access').value;
            }
            
            const url = id ? `${API_BASE_URL}/${id}` : API_BASE_URL;
            const method = id ? 'PUT' : 'POST';

            if (!id) {
                patientData.createdAt = new Date().toISOString();
            }

            try {
                const response = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(patientData) });
                if (!response.ok) throw new Error('Save error');
                
                const savedPatient = await response.json();
                if (id) {
                    const index = allPatients.findIndex(p => p.id === id);
                    if (index !== -1) allPatients[index] = savedPatient;
                } else {
                    allPatients.push(savedPatient);
                }
                
                closeModal();
                renderAll(); // 只重繪畫面，不重抓全部資料
            } catch (error) { console.error("Save failed:", error); alert("儲存失敗！"); }
        };

        const updatePatientField = async (id, dataToUpdate) => {
            const patient = allPatients.find(p => p.id === id);
            if (!patient) return;

             try {
                const response = await fetch(`${API_BASE_URL}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...patient, ...dataToUpdate }) // 合併舊資料與新資料
                });
                if (!response.ok) throw new Error('Update error');
                
                const updatedPatient = await response.json();
                const index = allPatients.findIndex(p => p.id === id);
                if (index !== -1) allPatients[index] = updatedPatient;
                
                renderAll();
            } catch (error) { console.error("Update failed:", error); alert("操作失敗！"); }
        };
        
        const transferToOpd = async (id) => { if (!confirm('確定要將此病人轉為門診常規嗎？')) return; await updatePatientField(id, { status: 'opd' }); };
        
        const archivePatient = async (id, reason) => {
            await updatePatientField(id, {
                isDeleted: true, status: 'deleted', deleteReason: reason, deletedAt: new Date().toISOString()
            });
        };
        
        const restorePatient = async (id) => {
            const patient = allPatients.find(p => p.id === id);
            if (!patient || !confirm(`確定要將病人「${patient.name}」復原到「${patient.originalStatus === 'ipd' ? '住院' : '門診'}」列表嗎？`)) return;
            await updatePatientField(id, {
                isDeleted: false, status: patient.originalStatus, deleteReason: null, deletedAt: null
            });
        };
        
        const deletePatient = (id) => { /* ...與V1.2相同... */ };
        // --- CHANGE END ---
        
        // --- 其他所有非儲存相關的函式，都與 V1.2 相同 ---
        const fetchAllPatients = async () => { /* ... */ };
        const renderAll = () => { /* ... */ };
        // ...等等
        
        // --- Expose functions to global scope (新增 restorePatient) ---
        window.app = { editPatient: (id) => { /*...*/ }, deletePatient, transferToOpd, restorePatient };
        
        // --- 事件監聽器 (無變動) ---
        // ...

        // 初始載入
        fetchAllPatients();
    });
    </script>
</body>
</html>
